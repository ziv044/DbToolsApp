# Story 3.6: Server Health Status API

## Status: Ready for Review

## Story

**As a** user,
**I want** to query current health status of servers,
**so that** I know which servers need attention.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `GET /api/servers/health` returns health status for all servers |
| 2 | Health status: healthy, warning, critical, offline, unknown |
| 3 | Status based on latest snapshot: CPU >80% = warning, >95% = critical |
| 4 | Status based on latest snapshot: Memory >85% = warning, >95% = critical |
| 5 | Offline if no successful collection in last 5 minutes |
| 6 | Unknown if server never collected or collection disabled |
| 7 | Response includes: server_id, name, status, last_collected_at, cpu, memory |
| 8 | `GET /api/servers/{id}/health` returns single server health |
| 9 | Health thresholds configurable via tenant settings |

## Tasks / Subtasks

- [x] Task 1: Create health calculation service (AC: 2, 3, 4, 5, 6)
- [x] Task 2: Create health API endpoints (AC: 1, 7, 8)
- [x] Task 3: Add configurable thresholds (AC: 9)

## Dev Notes

### Health Calculation
```python
def calculate_health(server, latest_snapshot):
    if not latest_snapshot:
        return 'unknown'

    if (datetime.utcnow() - latest_snapshot.collected_at).seconds > 300:
        return 'offline'

    cpu = latest_snapshot.metrics.get('cpu_percent', 0)
    memory = latest_snapshot.metrics.get('memory_percent', 0)

    if cpu > 95 or memory > 95:
        return 'critical'
    if cpu > 80 or memory > 85:
        return 'warning'
    return 'healthy'
```

### Response Format
```json
[
  {
    "server_id": "uuid",
    "name": "sql-prod-01",
    "status": "healthy",
    "last_collected_at": "2026-01-17T10:00:00Z",
    "cpu_percent": 45,
    "memory_percent": 62
  }
]
```

## Testing

- Test health calculation logic
- Test API responses

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created HealthService with:
  - calculate_health(): Determines health status based on latest snapshot
  - get_server_health(): Returns health for a single server
  - get_all_servers_health(): Returns health for all servers
  - get_thresholds(): Returns current threshold settings
  - update_thresholds(): Updates threshold settings with validation
- Health status values: healthy, warning, critical, offline, unknown
- Default thresholds:
  - CPU: >80% warning, >95% critical
  - Memory: >85% warning, >95% critical
  - Offline: >300 seconds since last collection
- Created API endpoints:
  - GET /api/servers/health: Returns health status for all servers
  - GET /api/servers/{id}/health: Returns health for a single server
  - GET /api/settings/health-thresholds: Returns current thresholds
  - PUT /api/settings/health-thresholds: Updates thresholds
- Response includes: server_id, name, hostname, status, last_collected_at, cpu_percent, memory_percent, connection_count, collection_enabled
- Configurable thresholds stored in tenant settings
- All 72 backend tests passing

### File List
- backend/app/services/health_service.py (new)
- backend/app/api/servers.py (modified - added health endpoints)

---

## QA Results
