# Story 4.11: Alert Rules Data Model & API

## Status: Ready for Review

## Story

**As a** user,
**I want** to define alert rules based on metrics,
**so that** I'm notified when servers need attention.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `alert_rules` table: id, name, metric_type, operator, threshold, severity, is_enabled, created_at |
| 2 | Tenant DB includes `alerts` table: id, rule_id, server_id, status (active/acknowledged/resolved), triggered_at, resolved_at |
| 3 | Operators: gt, gte, lt, lte, eq |
| 4 | Severity levels: info, warning, critical |
| 5 | `POST /api/alert-rules` creates new rule |
| 6 | `GET /api/alert-rules` returns all rules |
| 7 | `PUT /api/alert-rules/{id}` updates rule |
| 8 | `DELETE /api/alert-rules/{id}` deletes rule |
| 9 | `GET /api/alerts` returns active alerts |
| 10 | `POST /api/alerts/{id}/acknowledge` marks alert acknowledged |
| 11 | Alerts auto-resolve when condition no longer met |

## Tasks / Subtasks

- [x] Task 1: Create AlertRule model (AC: 1, 3, 4)
- [x] Task 2: Create Alert model (AC: 2)
- [x] Task 3: Create alert rules API (AC: 5-8)
- [x] Task 4: Create alerts API (AC: 9, 10)
- [x] Task 5: Implement auto-resolve logic (AC: 11)

## Dev Notes

### Models
```python
class AlertRule(db.Model):
    __tablename__ = 'alert_rules'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False)
    metric_type = db.Column(db.String(50), nullable=False)
    operator = db.Column(db.String(10), nullable=False)  # gt, gte, lt, lte, eq
    threshold = db.Column(db.Float, nullable=False)
    severity = db.Column(db.String(20), nullable=False)  # info, warning, critical
    is_enabled = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, server_default=db.func.now())

class Alert(db.Model):
    __tablename__ = 'alerts'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    rule_id = db.Column(UUID(as_uuid=True), db.ForeignKey('alert_rules.id'))
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'), nullable=False)
    status = db.Column(db.String(20), nullable=False, default='active')
    triggered_at = db.Column(db.DateTime, server_default=db.func.now())
    acknowledged_at = db.Column(db.DateTime)
    resolved_at = db.Column(db.DateTime)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Added `AlertRule` model to `backend/app/models/tenant.py`:
  - Fields: id, name, metric_type, operator, threshold, severity, is_enabled, created_at, updated_at
  - Operators: gt, gte, lt, lte, eq (VALID_OPERATORS)
  - Severities: info, warning, critical (VALID_SEVERITIES)
  - Valid metric types: cpu_percent, memory_percent, connection_count, etc.
  - `evaluate(value)` method to check if a metric value triggers the rule
- Added `Alert` model to `backend/app/models/tenant.py`:
  - Fields: id, rule_id, server_id, status, metric_value, triggered_at, acknowledged_at, acknowledged_by, resolved_at, notes
  - Statuses: active, acknowledged, resolved (VALID_STATUSES)
  - Indexes on status, rule_id+server_id, triggered_at
  - Relationships to AlertRule and Server
- Created `backend/app/services/alert_service.py`:
  - `AlertService` class with full CRUD for rules and alerts
  - `create_rule()`, `get_rule()`, `get_all_rules()`, `update_rule()`, `delete_rule()`
  - `enable_rule()`, `disable_rule()`
  - `get_alert()`, `get_all_alerts()`, `acknowledge_alert()`, `resolve_alert()`
  - `create_alert()`, `get_active_alert_for_rule_server()`
  - `auto_resolve_alerts_for_server()` - auto-resolves alerts when condition no longer met
  - `evaluate_rules_for_server()` - evaluates all rules and creates new alerts
  - `get_alert_counts_by_severity()` - returns counts grouped by severity
- Created `backend/app/api/alerts.py` with all endpoints:
  - `POST /api/alert-rules` - create rule
  - `GET /api/alert-rules` - list rules with filters
  - `GET /api/alert-rules/{id}` - get rule
  - `PUT /api/alert-rules/{id}` - update rule
  - `DELETE /api/alert-rules/{id}` - delete rule
  - `POST /api/alert-rules/{id}/enable` - enable rule
  - `POST /api/alert-rules/{id}/disable` - disable rule
  - `GET /api/alerts` - list alerts with filters
  - `GET /api/alerts/active` - list active/acknowledged alerts
  - `GET /api/alerts/counts` - get counts by severity
  - `GET /api/alerts/{id}` - get alert
  - `POST /api/alerts/{id}/acknowledge` - acknowledge alert
  - `POST /api/alerts/{id}/resolve` - resolve alert
- Registered alerts API in `backend/app/api/__init__.py`
- All 72 backend tests pass

### File List
- backend/app/models/tenant.py (modified - added AlertRule, Alert models)
- backend/app/services/alert_service.py (new)
- backend/app/api/alerts.py (new)
- backend/app/api/__init__.py (modified - added alerts import)

---

## QA Results
