# Story 4.11: Alert Rules Data Model & API

## Status: Draft

## Story

**As a** user,
**I want** to define alert rules based on metrics,
**so that** I'm notified when servers need attention.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `alert_rules` table: id, name, metric_type, operator, threshold, severity, is_enabled, created_at |
| 2 | Tenant DB includes `alerts` table: id, rule_id, server_id, status (active/acknowledged/resolved), triggered_at, resolved_at |
| 3 | Operators: gt, gte, lt, lte, eq |
| 4 | Severity levels: info, warning, critical |
| 5 | `POST /api/alert-rules` creates new rule |
| 6 | `GET /api/alert-rules` returns all rules |
| 7 | `PUT /api/alert-rules/{id}` updates rule |
| 8 | `DELETE /api/alert-rules/{id}` deletes rule |
| 9 | `GET /api/alerts` returns active alerts |
| 10 | `POST /api/alerts/{id}/acknowledge` marks alert acknowledged |
| 11 | Alerts auto-resolve when condition no longer met |

## Tasks / Subtasks

- [ ] Task 1: Create AlertRule model (AC: 1, 3, 4)
- [ ] Task 2: Create Alert model (AC: 2)
- [ ] Task 3: Create alert rules API (AC: 5-8)
- [ ] Task 4: Create alerts API (AC: 9, 10)
- [ ] Task 5: Implement auto-resolve logic (AC: 11)

## Dev Notes

### Models
```python
class AlertRule(db.Model):
    __tablename__ = 'alert_rules'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False)
    metric_type = db.Column(db.String(50), nullable=False)
    operator = db.Column(db.String(10), nullable=False)  # gt, gte, lt, lte, eq
    threshold = db.Column(db.Float, nullable=False)
    severity = db.Column(db.String(20), nullable=False)  # info, warning, critical
    is_enabled = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, server_default=db.func.now())

class Alert(db.Model):
    __tablename__ = 'alerts'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    rule_id = db.Column(UUID(as_uuid=True), db.ForeignKey('alert_rules.id'))
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'), nullable=False)
    status = db.Column(db.String(20), nullable=False, default='active')
    triggered_at = db.Column(db.DateTime, server_default=db.func.now())
    acknowledged_at = db.Column(db.DateTime)
    resolved_at = db.Column(db.DateTime)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
