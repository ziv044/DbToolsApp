# Story 4.2: Policy Configuration Schemas

## Status: Ready for Review

## Story

**As a** user,
**I want** structured configuration options for each policy type,
**so that** I can define policies without writing raw scripts.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Backup policy config: backup_type (full/diff/log), destination_path, compression (bool), retention_days |
| 2 | Index maintenance config: fragmentation_threshold (%), rebuild_threshold (%), include_statistics (bool) |
| 3 | Integrity check config: check_type (physical/logical/both), include_indexes (bool) |
| 4 | Custom script config: script_content (T-SQL), timeout_seconds |
| 5 | JSON Schema validation for each policy type |
| 6 | `GET /api/policies/schemas` returns schemas for all policy types |
| 7 | API returns 400 with specific validation errors if config invalid |
| 8 | Default values populated for optional fields |

## Tasks / Subtasks

- [x] Task 1: Define JSON schemas for each type (AC: 1-4)
- [x] Task 2: Implement validation (AC: 5, 7)
- [x] Task 3: Create schemas endpoint (AC: 6)
- [x] Task 4: Add default values (AC: 8)

## Dev Notes

### Policy Schemas
```python
POLICY_SCHEMAS = {
    'backup': {
        'type': 'object',
        'properties': {
            'backup_type': {'enum': ['full', 'differential', 'log']},
            'destination_path': {'type': 'string'},
            'compression': {'type': 'boolean', 'default': True},
            'retention_days': {'type': 'integer', 'minimum': 1, 'default': 30}
        },
        'required': ['backup_type', 'destination_path']
    },
    'index_maintenance': {
        'type': 'object',
        'properties': {
            'fragmentation_threshold': {'type': 'integer', 'minimum': 0, 'maximum': 100, 'default': 10},
            'rebuild_threshold': {'type': 'integer', 'minimum': 0, 'maximum': 100, 'default': 30},
            'include_statistics': {'type': 'boolean', 'default': True}
        }
    }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- All schema functionality was implemented as part of Story 4.1
- POLICY_SCHEMAS in `policy_service.py` defines schemas for all 4 policy types:
  - **backup**: backup_type (full/differential/log), destination_path, compression (default: true), retention_days (default: 7), verify_backup (default: true), copy_only (default: false)
  - **index_maintenance**: fragmentation_threshold (default: 10), rebuild_threshold (default: 30), include_statistics (default: true), max_dop (default: 0), online (default: true)
  - **integrity_check**: check_type (physical/logical/both, default: physical), include_indexes (default: true), include_extended_logical_checks (default: false), max_dop (default: 0)
  - **custom_script**: script_content (required), timeout_seconds (default: 3600), run_as_user (optional)
- validate_configuration() in PolicyService validates all policy configs with:
  - Required field checking
  - Valid value validation (enums)
  - Numeric range validation
  - Default value population
- GET /api/policies/schemas returns all schemas
- GET /api/policies/schemas/{type} returns specific schema
- API returns 400 with detailed validation errors on invalid config

### File List
- backend/app/services/policy_service.py (implemented in Story 4.1)
- backend/app/api/policies.py (implemented in Story 4.1)

---

## QA Results
