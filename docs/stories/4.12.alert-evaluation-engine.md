# Story 4.12: Alert Evaluation Engine

## Status: Draft

## Story

**As the** system,
**I want** to evaluate alert rules against collected metrics,
**so that** alerts are triggered when thresholds are exceeded.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Alert evaluator runs after each metric collection cycle |
| 2 | Compares latest metrics against all enabled alert rules |
| 3 | Creates alert record when threshold breached |
| 4 | Does not duplicate alerts (one active alert per rule per server) |
| 5 | Resolves alert when metric returns to normal for 2 consecutive checks |
| 6 | Updates server health status based on active alerts |
| 7 | Logs alert state changes to activity log |
| 8 | Supports evaluation of aggregate metrics (avg over 5 min) |
| 9 | Alert evaluation completes within 1 second per tenant |

## Tasks / Subtasks

- [ ] Task 1: Create AlertEvaluator service (AC: 1, 2)
- [ ] Task 2: Implement threshold checking (AC: 3, 4)
- [ ] Task 3: Implement auto-resolve logic (AC: 5)
- [ ] Task 4: Update server health (AC: 6)
- [ ] Task 5: Add activity logging (AC: 7)
- [ ] Task 6: Add aggregate support (AC: 8)

## Dev Notes

### Alert Evaluator
```python
class AlertEvaluator:
    OPERATORS = {
        'gt': lambda v, t: v > t,
        'gte': lambda v, t: v >= t,
        'lt': lambda v, t: v < t,
        'lte': lambda v, t: v <= t,
        'eq': lambda v, t: v == t,
    }

    def evaluate(self, server, snapshot, rules):
        for rule in rules:
            value = snapshot.metrics.get(rule.metric_type)
            if value is None:
                continue

            check = self.OPERATORS[rule.operator]
            if check(value, rule.threshold):
                self.trigger_or_update_alert(server, rule)
            else:
                self.maybe_resolve_alert(server, rule)

    def trigger_or_update_alert(self, server, rule):
        existing = Alert.query.filter_by(
            server_id=server.id,
            rule_id=rule.id,
            status='active'
        ).first()
        if not existing:
            alert = Alert(server_id=server.id, rule_id=rule.id, status='active')
            db.session.add(alert)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
