# Story 4.6: Job Scheduler Engine

## Status: Ready for Review

## Story

**As the** system,
**I want** a reliable scheduler that executes jobs on time,
**so that** automated operations run as configured.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Scheduler runs as background process using APScheduler |
| 2 | Polls for jobs where next_run_at <= now and is_enabled = true |
| 3 | Executes job based on type (calls appropriate handler) |
| 4 | Creates job_execution record on start with status = 'running' |
| 5 | Updates job_execution on completion with status = 'success' or 'failed' |
| 6 | Calculates and sets next_run_at based on schedule config |
| 7 | Supports job concurrency limits (default: 5 simultaneous) |
| 8 | Job execution timeout (default: 30 minutes) |
| 9 | Failed jobs logged with full error details |
| 10 | Scheduler recovers gracefully after restart (picks up missed jobs) |
| 11 | Handles multiple tenants (queries all tenant DBs) |

## Tasks / Subtasks

- [x] Task 1: Create scheduler worker (AC: 1, 10)
- [x] Task 2: Implement job polling (AC: 2, 11)
- [x] Task 3: Implement job execution (AC: 3, 4, 5, 7, 8)
- [x] Task 4: Implement next_run calculation (AC: 6)
- [x] Task 5: Add error handling (AC: 9)

## Dev Notes

### Scheduler Worker
```python
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.interval import IntervalTrigger

class JobSchedulerWorker:
    def __init__(self):
        self.app = create_app()
        self.scheduler = BackgroundScheduler()
        self.executor = ThreadPoolExecutor(max_workers=5)

    def start(self):
        self.scheduler.add_job(
            self.check_jobs,
            IntervalTrigger(seconds=30),
            id='job_checker'
        )
        self.scheduler.start()

    def check_jobs(self):
        with self.app.app_context():
            for tenant in Tenant.query.filter_by(status='active').all():
                self.process_tenant_jobs(tenant)

    def process_tenant_jobs(self, tenant):
        session = tenant_manager.get_session(tenant.slug)
        due_jobs = session.query(Job).filter(
            Job.next_run_at <= datetime.utcnow(),
            Job.is_enabled == True
        ).all()
        for job in due_jobs:
            self.executor.submit(self.execute_job, tenant.slug, job)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created `backend/app/services/scheduler_service.py`:
  - `SchedulerService` class with:
    - `get_due_jobs()` - queries jobs where next_run_at <= now and is_enabled = True
    - `create_execution()` - creates JobExecution with status='running'
    - `complete_execution()` - marks execution as success/failed with result
    - `calculate_next_run()` - calculates next run based on schedule type (once, interval, cron, event_triggered)
    - `update_job_after_execution()` - updates job's last_run_at and next_run_at
  - `JobExecutor` class with:
    - ThreadPoolExecutor with configurable max_workers (default: 5)
    - `register_handler()` - register handler functions for job types
    - `execute()` - executes job with timeout handling
  - `JobExecutionContext` - context object for job execution
  - Default handlers for: policy_execution, data_collection, custom_script, alert_check
  - `create_default_executor()` factory function
- Created `backend/app/workers/scheduler_worker.py`:
  - `JobSchedulerWorker` class:
    - Uses APScheduler BackgroundScheduler
    - Configurable poll interval (default: 30 seconds)
    - Polls all active tenants for due jobs
    - Executes jobs with proper error handling
    - Graceful shutdown on SIGINT/SIGTERM
    - `run_forever()` method for standalone execution
  - CLI entry point with argparse for --poll-interval, --max-workers, --timeout
- Created `backend/app/workers/__init__.py` with exports
- Added `croniter>=1.3.0` to requirements.txt for cron expression parsing
- All 72 backend tests pass

### File List
- backend/app/services/scheduler_service.py (new)
- backend/app/workers/scheduler_worker.py (new)
- backend/app/workers/__init__.py (new)
- backend/requirements.txt (modified - added croniter)

---

## QA Results
