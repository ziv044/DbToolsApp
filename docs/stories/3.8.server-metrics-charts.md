# Story 3.8: Server Metrics Charts

## Status: Draft

## Story

**As a** user,
**I want** to see historical metrics for a server,
**so that** I can analyze performance trends.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Server detail page includes "Metrics" tab |
| 2 | Time range selector: Last 1 hour, 6 hours, 24 hours, 7 days, 30 days |
| 3 | CPU utilization line chart over selected time range |
| 4 | Memory utilization line chart over selected time range |
| 5 | Connection count line chart |
| 6 | Charts use appropriate data aggregation (avg per 5 min for >24h) |
| 7 | `GET /api/servers/{id}/metrics?range=24h&metric=cpu` returns time series |
| 8 | Charts built with lightweight library (Chart.js or Recharts) |
| 9 | Tooltip shows exact value and timestamp on hover |
| 10 | Loading skeleton while data fetches |
| 11 | "No data" message if collection hasn't run |

## Tasks / Subtasks

- [ ] Task 1: Create metrics API (AC: 6, 7)
- [ ] Task 2: Install chart library (AC: 8)
- [ ] Task 3: Create time range selector (AC: 2)
- [ ] Task 4: Create metric charts (AC: 3, 4, 5, 9)
- [ ] Task 5: Add loading/empty states (AC: 10, 11)
- [ ] Task 6: Add metrics tab to server detail (AC: 1)

## Dev Notes

### Metrics API
```python
@bp.route('/<uuid:server_id>/metrics')
def get_metrics(server_id):
    range_param = request.args.get('range', '24h')
    metric = request.args.get('metric', 'cpu')

    # Calculate time range
    ranges = {'1h': 1, '6h': 6, '24h': 24, '7d': 168, '30d': 720}
    hours = ranges.get(range_param, 24)
    start = datetime.utcnow() - timedelta(hours=hours)

    # Query and aggregate
    snapshots = MetricSnapshot.query.filter(
        MetricSnapshot.server_id == server_id,
        MetricSnapshot.collected_at >= start
    ).order_by(MetricSnapshot.collected_at).all()

    return [{'time': s.collected_at.isoformat(), 'value': s.metrics.get(metric)} for s in snapshots]
```

### Chart Component
```typescript
import { LineChart, Line, XAxis, YAxis, Tooltip } from 'recharts';

<LineChart data={data}>
  <XAxis dataKey="time" />
  <YAxis domain={[0, 100]} />
  <Tooltip />
  <Line type="monotone" dataKey="value" stroke="#3b82f6" />
</LineChart>
```

## Testing

- Test metrics API returns data
- Test charts render
- Test time range switching

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
