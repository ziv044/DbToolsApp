# Story 3.9: Real-Time Status Updates

## Status: Ready for Review

## Story

**As a** user,
**I want** server status to update without page refresh,
**so that** I always see current state.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Dashboard polls `/api/servers/health` every 30 seconds |
| 2 | Status changes trigger visual transition (fade/pulse animation) |
| 3 | Browser tab title shows alert count: "(3) DbTools" if 3 critical |
| 4 | Optional: Desktop notification on status change to critical (with permission) |
| 5 | Polling pauses when browser tab is hidden (visibility API) |
| 6 | Polling resumes immediately when tab becomes visible |
| 7 | Connection error shows banner, retries with exponential backoff |
| 8 | Server list view also updates status in real-time |

## Tasks / Subtasks

- [x] Task 1: Implement polling with TanStack Query (AC: 1)
- [x] Task 2: Add status change animations (AC: 2)
- [x] Task 3: Update browser tab title (AC: 3)
- [x] Task 4: Add visibility API handling (AC: 5, 6)
- [x] Task 5: Add error handling with retry (AC: 7)
- [ ] Task 6: Optional: Add notifications (AC: 4) - Skipped (optional)

## Dev Notes

### Polling with Visibility
```typescript
const { data } = useQuery({
  queryKey: ['servers', 'health'],
  queryFn: serverService.getHealth,
  refetchInterval: (query) => {
    // Pause when tab is hidden
    return document.visibilityState === 'visible' ? 30_000 : false;
  },
});

useEffect(() => {
  const handler = () => {
    if (document.visibilityState === 'visible') {
      queryClient.invalidateQueries(['servers', 'health']);
    }
  };
  document.addEventListener('visibilitychange', handler);
  return () => document.removeEventListener('visibilitychange', handler);
}, []);
```

### Tab Title Update
```typescript
useEffect(() => {
  const critical = servers.filter(s => s.status === 'critical').length;
  document.title = critical > 0 ? `(${critical}) DbTools` : 'DbTools';
}, [servers]);
```

## Testing

- Test polling occurs
- Test visibility pause/resume
- Test tab title updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed unused import warning for useCallback in Dashboard.tsx

### Completion Notes List
- Dashboard.tsx enhancements:
  - Added visibility API handling (pause polling when tab hidden, resume on visible)
  - Added browser tab title update with alert count `(N) DbTools`
  - Added status change animation tracking with animate-pulse effect
  - Added exponential backoff retry (1s, 2s, 4s, up to 30s max)
  - Added connection error banner that shows during errors while still displaying cached data
- Servers.tsx enhancements:
  - Added visibility API handling to pause/resume polling
  - Added health data fetching and merging with server data
  - Server list now shows real-time health status
  - Refresh button now refreshes both server data and health data
- ServerList.tsx:
  - Updated status variants to include 'healthy' and 'critical' statuses
- All criteria met except optional desktop notifications (AC: 4)

### File List
- frontend/src/pages/Dashboard.tsx (modified)
- frontend/src/pages/Servers.tsx (modified)
- frontend/src/components/servers/ServerList.tsx (modified)

---

## QA Results
