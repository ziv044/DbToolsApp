# Story 4.7: Job Scheduler API

## Status: Ready for Review

## Story

**As a** user,
**I want** to manage scheduled jobs via API,
**so that** I can create, modify, and monitor automation.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `POST /api/jobs` creates new scheduled job |
| 2 | `GET /api/jobs` returns all jobs with next_run_at and status |
| 3 | `GET /api/jobs/{id}` returns job with recent execution history |
| 4 | `PUT /api/jobs/{id}` updates job configuration and schedule |
| 5 | `DELETE /api/jobs/{id}` soft-deletes job |
| 6 | `POST /api/jobs/{id}/run` triggers immediate execution |
| 7 | `POST /api/jobs/{id}/enable` enables disabled job |
| 8 | `POST /api/jobs/{id}/disable` disables job (stops scheduling) |
| 9 | `GET /api/jobs/{id}/executions` returns paginated execution history |
| 10 | `GET /api/jobs/{id}/executions/{exec_id}` returns execution details |

## Tasks / Subtasks

- [x] Task 1: Create job repository and service
- [x] Task 2: Create job API endpoints (AC: 1-5)
- [x] Task 3: Implement run-now endpoint (AC: 6)
- [x] Task 4: Implement enable/disable (AC: 7, 8)
- [x] Task 5: Create execution history endpoints (AC: 9, 10)

## Dev Notes

### API Examples
```json
// POST /api/jobs
{
  "name": "Nightly Backup",
  "type": "policy_execution",
  "configuration": {"policy_id": "uuid"},
  "schedule_type": "cron",
  "schedule_config": {"expression": "0 2 * * *"}
}

// GET /api/jobs
[
  {
    "id": "uuid",
    "name": "Nightly Backup",
    "type": "policy_execution",
    "is_enabled": true,
    "next_run_at": "2026-01-18T02:00:00Z",
    "last_status": "success"
  }
]
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created `backend/app/services/job_service.py`:
  - `JobService` class with full CRUD operations:
    - `validate_job_input()` - validates job creation/update data
    - `create_job()` - creates job with schedule validation
    - `get_job()`, `get_all_jobs()` - retrieve jobs
    - `update_job()` - updates job with schedule recalculation
    - `delete_job()` - deletes job
    - `enable_job()`, `disable_job()` - toggle job state
    - `run_job_now()` - triggers immediate execution
    - `get_job_executions()` - paginated execution history
    - `get_execution()` - single execution details
    - `get_job_with_last_execution()` - job with last_status
  - `JobValidationError` exception class
- Created `backend/app/api/jobs.py` with all endpoints:
  - `POST /api/jobs` - create job
  - `GET /api/jobs` - list jobs with filters and pagination
  - `GET /api/jobs/{id}` - get job with recent executions
  - `PUT /api/jobs/{id}` - update job
  - `DELETE /api/jobs/{id}` - delete job
  - `POST /api/jobs/{id}/run` - trigger immediate execution
  - `POST /api/jobs/{id}/enable` - enable job
  - `POST /api/jobs/{id}/disable` - disable job
  - `GET /api/jobs/{id}/executions` - paginated execution history
  - `GET /api/jobs/{id}/executions/{exec_id}` - execution details
- Registered jobs API in `backend/app/api/__init__.py`
- All 72 backend tests pass

### File List
- backend/app/services/job_service.py (new)
- backend/app/api/jobs.py (new)
- backend/app/api/__init__.py (modified - added jobs import)

---

## QA Results
