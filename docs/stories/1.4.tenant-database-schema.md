# Story 1.4: Tenant Database Schema (Template)

## Status: Draft

## Story

**As a** developer,
**I want** a standardized schema for tenant databases,
**so that** all tenants have consistent table structures.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant migration template includes: settings, activity_log tables |
| 2 | Settings table: key (unique), value (JSON), updated_at |
| 3 | Activity_log table: id, action, entity_type, entity_id, details (JSON), created_at |
| 4 | Migrations versioned and can be run on all tenant DBs via script |
| 5 | Script to apply pending migrations to all active tenants |
| 6 | Foreign key constraints and indexes properly defined |

## Tasks / Subtasks

- [ ] Task 1: Create tenant migrations structure (AC: 1, 4)
  - [ ] Create `backend/migrations_tenant/` folder
  - [ ] Create `backend/migrations_tenant/env.py` for Alembic
  - [ ] Create `backend/migrations_tenant/alembic.ini`
  - [ ] Configure for dynamic database URL

- [ ] Task 2: Create base table migrations (AC: 2, 3, 6)
  - [ ] Create migration for settings table
  - [ ] Create migration for activity_log table
  - [ ] Add proper indexes

- [ ] Task 3: Create migration runner script (AC: 4, 5)
  - [ ] Create `scripts/migrate_all_tenants.py`
  - [ ] Query all active tenants from system DB
  - [ ] Run pending migrations on each tenant DB
  - [ ] Log results and errors

- [ ] Task 4: Update TenantManager (AC: 4)
  - [ ] Add `run_tenant_migrations(slug)` method
  - [ ] Integrate with provisioning flow

## Dev Notes

### Tenant Migrations Structure
```
backend/
├── migrations/              # System DB migrations (Flask-Migrate)
└── migrations_tenant/       # Tenant DB migrations (Alembic)
    ├── alembic.ini
    ├── env.py
    └── versions/
        ├── 001_create_settings.py
        └── 002_create_activity_log.py
```

### Tenant Alembic env.py
```python
# Dynamic URL from environment or parameter
def get_url():
    return os.environ.get('TENANT_DB_URL')

def run_migrations_online():
    connectable = create_engine(get_url())
    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)
        with context.begin_transaction():
            context.run_migrations()
```

### Migration Script Pattern
```python
# scripts/migrate_all_tenants.py
from app import create_app
from app.extensions import db
from app.models.system import Tenant
from app.core.tenant_manager import tenant_manager

app = create_app()
with app.app_context():
    tenants = Tenant.query.filter_by(status='active').all()
    for tenant in tenants:
        print(f"Migrating {tenant.slug}...")
        tenant_manager.run_migrations(tenant.slug)
```

## Testing

### Test Requirements
- Test migration creates tables correctly
- Test script runs on multiple tenants
- Test idempotent (running twice is safe)
- Location: `backend/tests/integration/test_tenant_migrations.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
