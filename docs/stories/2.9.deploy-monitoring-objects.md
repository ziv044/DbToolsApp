# Story 2.9: Deploy Monitoring Objects to SQL Server

## Status: Draft

## Story

**As a** user,
**I want** DbTools to deploy required monitoring objects to my SQL Servers,
**so that** data collection can begin.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `POST /api/servers/{id}/deploy` deploys monitoring objects to target |
| 2 | Creates `DbTools` schema on target SQL Server |
| 3 | Deploys stored procedures for metric collection (CPU, memory, waits, etc.) |
| 4 | Deploys configuration table for collection settings |
| 5 | Returns deployment status: success or error with details |
| 6 | Deployment is idempotent (can re-run safely) |
| 7 | Validates target has required permissions before deployment |
| 8 | Server status changes to "Monitored" after successful deployment |
| 9 | `GET /api/servers/{id}/deployment-status` returns current state |
| 10 | UI shows deployment status and "Deploy" button on server detail |
| 11 | Deployment script version tracked for future upgrades |

## Tasks / Subtasks

- [ ] Task 1: Create deployment scripts (AC: 2, 3, 4)
  - [ ] Create `backend/app/connectors/scripts/` folder
  - [ ] Create schema creation script
  - [ ] Create stored procedures for metrics
  - [ ] Create config table script

- [ ] Task 2: Implement deployment logic (AC: 1, 5, 6, 7)
  - [ ] Add `deploy_monitoring()` to SQLServerConnector
  - [ ] Execute scripts in transaction
  - [ ] Make idempotent (IF NOT EXISTS)
  - [ ] Validate permissions first

- [ ] Task 3: Create deployment API (AC: 1, 8, 9, 11)
  - [ ] Add POST /api/servers/{id}/deploy endpoint
  - [ ] Add GET /api/servers/{id}/deployment-status
  - [ ] Update server status on success
  - [ ] Track deployment version

- [ ] Task 4: Add deployment UI (AC: 10)
  - [ ] Add deployment status to server detail
  - [ ] Add "Deploy" button
  - [ ] Show progress/result

## Dev Notes

### Deployment Scripts
```sql
-- Create schema
IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'DbTools')
BEGIN
    EXEC('CREATE SCHEMA DbTools')
END

-- Create config table
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'DbTools.Config'))
BEGIN
    CREATE TABLE DbTools.Config (
        [Key] VARCHAR(100) PRIMARY KEY,
        [Value] NVARCHAR(MAX),
        UpdatedAt DATETIME DEFAULT GETDATE()
    )
END

-- Create metrics stored procedure
CREATE OR ALTER PROCEDURE DbTools.CollectMetrics
AS
BEGIN
    SELECT
        (SELECT TOP 1 SQLProcessUtilization
         FROM sys.dm_os_ring_buffers
         WHERE ring_buffer_type = N'RING_BUFFER_SCHEDULER_MONITOR'
         ORDER BY timestamp DESC) as cpu_percent,
        -- ... other metrics
END
```

### Deployment Status Model
```python
class DeploymentStatus:
    NOT_DEPLOYED = 'not_deployed'
    DEPLOYED = 'deployed'
    OUTDATED = 'outdated'
    FAILED = 'failed'
```

### API Responses
```json
// POST /api/servers/{id}/deploy - Success
{
  "success": true,
  "version": "1.0.0",
  "deployed_at": "2026-01-17T10:00:00Z"
}

// POST /api/servers/{id}/deploy - Failure
{
  "success": false,
  "error": "Insufficient permissions: CREATE PROCEDURE denied"
}

// GET /api/servers/{id}/deployment-status
{
  "status": "deployed",
  "version": "1.0.0",
  "deployed_at": "2026-01-17T10:00:00Z"
}
```

## Testing

### Test Requirements
- Test deployment creates schema and objects
- Test idempotent re-deployment
- Test permission validation
- Test status tracking
- Location: `backend/tests/integration/test_deployment.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
