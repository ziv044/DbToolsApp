# Story 3.5: Metrics Retention & Cleanup

## Status: Draft

## Story

**As a** user,
**I want** old metrics automatically purged,
**so that** database storage remains manageable.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Retention period configurable per tenant (default 30 days) |
| 2 | `GET /api/settings/retention` returns current retention config |
| 3 | `PUT /api/settings/retention` updates retention period |
| 4 | Background job runs daily to delete expired metrics |
| 5 | Cleanup deletes in batches (10,000 rows) to avoid long locks |
| 6 | Cleanup job logs rows deleted per tenant |
| 7 | `GET /api/metrics/stats` returns storage statistics (row counts, date range) |
| 8 | Minimum retention: 1 day, Maximum: 365 days |

## Tasks / Subtasks

- [ ] Task 1: Add retention settings API (AC: 1, 2, 3, 8)
- [ ] Task 2: Create cleanup worker (AC: 4, 5, 6)
- [ ] Task 3: Create stats endpoint (AC: 7)

## Dev Notes

### Cleanup Worker
```python
class MetricsCleanup:
    BATCH_SIZE = 10000

    def run_cleanup(self, tenant_slug: str, retention_days: int):
        cutoff = datetime.utcnow() - timedelta(days=retention_days)
        session = tenant_manager.get_session(tenant_slug)

        total_deleted = 0
        while True:
            deleted = session.query(MetricSnapshot).filter(
                MetricSnapshot.collected_at < cutoff
            ).limit(self.BATCH_SIZE).delete(synchronize_session=False)
            session.commit()
            total_deleted += deleted
            if deleted < self.BATCH_SIZE:
                break
        return total_deleted
```

## Testing

- Test retention config CRUD
- Test cleanup deletes old data
- Test batch deletion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
