# Story 3.5: Metrics Retention & Cleanup

## Status: Ready for Review

## Story

**As a** user,
**I want** old metrics automatically purged,
**so that** database storage remains manageable.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Retention period configurable per tenant (default 30 days) |
| 2 | `GET /api/settings/retention` returns current retention config |
| 3 | `PUT /api/settings/retention` updates retention period |
| 4 | Background job runs daily to delete expired metrics |
| 5 | Cleanup deletes in batches (10,000 rows) to avoid long locks |
| 6 | Cleanup job logs rows deleted per tenant |
| 7 | `GET /api/metrics/stats` returns storage statistics (row counts, date range) |
| 8 | Minimum retention: 1 day, Maximum: 365 days |

## Tasks / Subtasks

- [x] Task 1: Add retention settings API (AC: 1, 2, 3, 8)
- [x] Task 2: Create cleanup worker (AC: 4, 5, 6)
- [x] Task 3: Create stats endpoint (AC: 7)

## Dev Notes

### Cleanup Worker
```python
class MetricsCleanup:
    BATCH_SIZE = 10000

    def run_cleanup(self, tenant_slug: str, retention_days: int):
        cutoff = datetime.utcnow() - timedelta(days=retention_days)
        session = tenant_manager.get_session(tenant_slug)

        total_deleted = 0
        while True:
            deleted = session.query(MetricSnapshot).filter(
                MetricSnapshot.collected_at < cutoff
            ).limit(self.BATCH_SIZE).delete(synchronize_session=False)
            session.commit()
            total_deleted += deleted
            if deleted < self.BATCH_SIZE:
                break
        return total_deleted
```

## Testing

- Test retention config CRUD
- Test cleanup deletes old data
- Test batch deletion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created RetentionService with:
  - get_retention_days(): Returns current retention period (default 30 days)
  - set_retention_days(): Updates retention period with validation (1-365 days)
  - get_retention_config(): Returns full configuration including min/max
  - get_metrics_stats(): Returns storage statistics (row counts, date ranges)
- Created settings API endpoints:
  - GET /api/settings/retention: Returns retention configuration
  - PUT /api/settings/retention: Updates retention period
  - GET /api/metrics/stats: Returns storage statistics
- Created MetricsCleanup worker:
  - Runs cleanup every 24 hours (configurable)
  - Iterates over all active tenants
  - Deletes in batches of 10,000 rows to avoid long locks
  - Respects tenant-specific retention settings
  - Logs deleted rows per tenant
  - Signal handling for graceful shutdown (SIGTERM/SIGINT)
  - Can run once with --once flag for manual cleanup
- Retention bounds: minimum 1 day, maximum 365 days
- All 72 backend tests passing

### File List
- backend/app/services/retention_service.py (new)
- backend/app/api/settings.py (new)
- backend/app/api/__init__.py (modified - registered settings blueprint)
- backend/workers/metrics_cleanup.py (new)

---

## QA Results
