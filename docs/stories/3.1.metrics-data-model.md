# Story 3.1: Metrics Data Model

## Status: Ready for Review

## Story

**As a** developer,
**I want** a well-designed schema for storing collected metrics,
**so that** we can efficiently store and query time-series data.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `metric_types` table: id, name, unit, description |
| 2 | Tenant DB includes `metrics` table: id, server_id, metric_type_id, value (numeric), collected_at (timestamp) |
| 3 | Tenant DB includes `server_snapshots` table: id, server_id, cpu_percent, memory_percent, connection_count, status, collected_at |
| 4 | Index on (server_id, collected_at) for efficient time-range queries |
| 5 | Partitioning strategy documented for future scale (by month) |
| 6 | Seed metric types: cpu_percent, memory_percent, disk_io_reads, disk_io_writes, wait_time_ms, connection_count, batch_requests_sec |
| 7 | Collected_at stored in UTC |
| 8 | Retention policy field in tenant settings (default 30 days) |

## Tasks / Subtasks

- [x] Task 1: Create metric models (AC: 1, 2, 3)
  - [x] Add MetricType model
  - [x] Add Metric model
  - [x] Add ServerSnapshot model
  - [x] Create tenant migration

- [x] Task 2: Add indexes (AC: 4)
  - [x] Add composite index on metrics(server_id, collected_at)
  - [x] Add composite index on snapshots(server_id, collected_at)

- [x] Task 3: Create seed data (AC: 6)
  - [x] Create metric types seed script
  - [x] Run on tenant provisioning

- [x] Task 4: Add retention settings (AC: 8)
  - [x] Add default retention to tenant settings
  - [x] Document partitioning strategy (AC: 5)

## Dev Notes

### Models
```python
class MetricType(db.Model):
    __tablename__ = 'metric_types'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(50), unique=True, nullable=False)
    unit = db.Column(db.String(20))
    description = db.Column(db.Text)

class MetricSnapshot(db.Model):
    __tablename__ = 'metric_snapshots'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'), nullable=False)
    collected_at = db.Column(db.DateTime(timezone=True), nullable=False, index=True)
    metrics = db.Column(db.JSON, nullable=False)  # {cpu: 45, memory: 60, ...}

    __table_args__ = (
        db.Index('ix_metrics_server_time', 'server_id', 'collected_at'),
    )
```

### Seed Metric Types
```python
METRIC_TYPES = [
    ('cpu_percent', '%', 'CPU utilization percentage'),
    ('memory_percent', '%', 'Memory utilization percentage'),
    ('connection_count', 'count', 'Active connection count'),
    ('batch_requests_sec', 'req/s', 'Batch requests per second'),
    ('page_life_expectancy', 'sec', 'Page life expectancy'),
    ('blocked_processes', 'count', 'Number of blocked processes'),
]
```

## Testing

- Test models created correctly
- Test indexes exist
- Test seed data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created MetricType model with id, name (unique), unit, description
- Created ServerSnapshot model with:
  - Core metrics as columns: cpu_percent, memory_percent, connection_count, batch_requests_sec, page_life_expectancy, blocked_processes
  - extended_metrics as JSON for flexible additional data
  - Composite index ix_snapshots_server_time on (server_id, collected_at)
- Created Metric model for detailed individual metric data points with:
  - Foreign keys to servers and metric_types
  - Composite indexes: ix_metrics_server_time, ix_metrics_server_type_time
- Created Setting model for tenant-specific key-value settings with JSONB storage
- Created migration 006_create_metrics.py with all tables and indexes
- Created seed utilities:
  - app/seeds/metric_types.py: Seeds 9 metric types (cpu, memory, connections, batch requests, PLE, blocked processes, disk I/O reads/writes, wait time)
  - app/seeds/settings.py: Seeds default settings including metrics_retention_days=30
- All timestamps stored in UTC (DateTime with timezone=True)
- Partitioning strategy note: Future scale can partition by month using PostgreSQL native partitioning on collected_at column
- All 72 backend tests passing

### File List
- backend/app/models/tenant.py (modified - added MetricType, ServerSnapshot, Metric, Setting models)
- backend/migrations_tenant/versions/006_create_metrics.py (new)
- backend/app/seeds/__init__.py (new)
- backend/app/seeds/metric_types.py (new)
- backend/app/seeds/settings.py (new)

---

## QA Results
