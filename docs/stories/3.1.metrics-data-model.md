# Story 3.1: Metrics Data Model

## Status: Draft

## Story

**As a** developer,
**I want** a well-designed schema for storing collected metrics,
**so that** we can efficiently store and query time-series data.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `metric_types` table: id, name, unit, description |
| 2 | Tenant DB includes `metrics` table: id, server_id, metric_type_id, value (numeric), collected_at (timestamp) |
| 3 | Tenant DB includes `server_snapshots` table: id, server_id, cpu_percent, memory_percent, connection_count, status, collected_at |
| 4 | Index on (server_id, collected_at) for efficient time-range queries |
| 5 | Partitioning strategy documented for future scale (by month) |
| 6 | Seed metric types: cpu_percent, memory_percent, disk_io_reads, disk_io_writes, wait_time_ms, connection_count, batch_requests_sec |
| 7 | Collected_at stored in UTC |
| 8 | Retention policy field in tenant settings (default 30 days) |

## Tasks / Subtasks

- [ ] Task 1: Create metric models (AC: 1, 2, 3)
  - [ ] Add MetricType model
  - [ ] Add Metric model
  - [ ] Add ServerSnapshot model
  - [ ] Create tenant migration

- [ ] Task 2: Add indexes (AC: 4)
  - [ ] Add composite index on metrics(server_id, collected_at)
  - [ ] Add composite index on snapshots(server_id, collected_at)

- [ ] Task 3: Create seed data (AC: 6)
  - [ ] Create metric types seed script
  - [ ] Run on tenant provisioning

- [ ] Task 4: Add retention settings (AC: 8)
  - [ ] Add default retention to tenant settings
  - [ ] Document partitioning strategy (AC: 5)

## Dev Notes

### Models
```python
class MetricType(db.Model):
    __tablename__ = 'metric_types'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(50), unique=True, nullable=False)
    unit = db.Column(db.String(20))
    description = db.Column(db.Text)

class MetricSnapshot(db.Model):
    __tablename__ = 'metric_snapshots'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'), nullable=False)
    collected_at = db.Column(db.DateTime(timezone=True), nullable=False, index=True)
    metrics = db.Column(db.JSON, nullable=False)  # {cpu: 45, memory: 60, ...}

    __table_args__ = (
        db.Index('ix_metrics_server_time', 'server_id', 'collected_at'),
    )
```

### Seed Metric Types
```python
METRIC_TYPES = [
    ('cpu_percent', '%', 'CPU utilization percentage'),
    ('memory_percent', '%', 'Memory utilization percentage'),
    ('connection_count', 'count', 'Active connection count'),
    ('batch_requests_sec', 'req/s', 'Batch requests per second'),
    ('page_life_expectancy', 'sec', 'Page life expectancy'),
    ('blocked_processes', 'count', 'Number of blocked processes'),
]
```

## Testing

- Test models created correctly
- Test indexes exist
- Test seed data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
