# Story 4.5: Job Scheduler Data Model

## Status: Ready for Review

## Story

**As a** developer,
**I want** a flexible job scheduling schema,
**so that** we can support various scheduling patterns.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `jobs` table: id, name, type, configuration (JSON), schedule_type, schedule_config (JSON), is_enabled, next_run_at, created_at |
| 2 | Tenant DB includes `job_executions` table: id, job_id, server_id, status, started_at, completed_at, result (JSON), error_message |
| 3 | Schedule types: once, interval, cron, event_triggered |
| 4 | Interval config: { interval_seconds: 3600 } |
| 5 | Cron config: { expression: "0 2 * * *" } (2 AM daily) |
| 6 | Job types: policy_execution, data_collection, custom_script, alert_check |
| 7 | Index on next_run_at for efficient scheduler queries |
| 8 | Jobs linked to policy deployments via job_id in policy_deployments |

## Tasks / Subtasks

- [x] Task 1: Create Job model (AC: 1, 3, 4, 5, 6, 7)
- [x] Task 2: Create JobExecution model (AC: 2)
- [x] Task 3: Create migrations (model definitions auto-create tables)
- [x] Task 4: Link to policy deployments (AC: 8)

## Dev Notes

### Job Model
```python
class Job(db.Model):
    __tablename__ = 'jobs'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False)
    type = db.Column(db.String(50), nullable=False)
    configuration = db.Column(db.JSON, nullable=False, default=dict)
    schedule_type = db.Column(db.String(20), nullable=False)  # once, interval, cron
    schedule_config = db.Column(db.JSON, nullable=False)
    is_enabled = db.Column(db.Boolean, default=True)
    next_run_at = db.Column(db.DateTime, index=True)
    created_at = db.Column(db.DateTime, server_default=db.func.now())

class JobExecution(db.Model):
    __tablename__ = 'job_executions'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    job_id = db.Column(UUID(as_uuid=True), db.ForeignKey('jobs.id'), nullable=False)
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'))
    status = db.Column(db.String(20), nullable=False)  # pending, running, success, failed
    started_at = db.Column(db.DateTime)
    completed_at = db.Column(db.DateTime)
    result = db.Column(db.JSON)
    error_message = db.Column(db.Text)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Added `Job` model to `backend/app/models/tenant.py`:
  - Schedule types: once, interval, cron, event_triggered (VALID_SCHEDULE_TYPES)
  - Job types: policy_execution, data_collection, custom_script, alert_check (VALID_JOB_TYPES)
  - Fields: id, name, type, configuration (JSON), schedule_type, schedule_config (JSON), is_enabled, next_run_at (indexed), last_run_at, created_at, updated_at
  - Relationship to executions
  - to_dict() method with include_executions option
- Added `JobExecution` model to `backend/app/models/tenant.py`:
  - Statuses: pending, running, success, failed, cancelled (VALID_STATUSES)
  - Fields: id, job_id, server_id, status, started_at, completed_at, result (JSON), error_message, created_at
  - Indexes: ix_job_executions_job_started, ix_job_executions_status
  - Relationships to Job and Server
  - to_dict() method with include_job and include_server options
  - duration_seconds property for calculating execution time
- Updated `PolicyDeployment` model:
  - Added job_id field (ForeignKey to jobs.id with SET NULL on delete)
  - Added relationship to Job
  - Updated to_dict() to include job_id
- All 72 backend tests pass

### File List
- backend/app/models/tenant.py (modified - added Job, JobExecution, updated PolicyDeployment)

---

## QA Results
