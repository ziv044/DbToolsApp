# Story 2.2: Server Connection Validation

## Status: Draft

## Story

**As a** user,
**I want** to test connectivity when adding a server,
**so that** I know the connection details are correct before saving.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `POST /api/servers/test-connection` tests connectivity without saving |
| 2 | Uses pyodbc to attempt connection to SQL Server |
| 3 | Returns success with SQL Server version and edition on connect |
| 4 | Returns failure with descriptive error (timeout, auth failed, unreachable) |
| 5 | Connection test has 10-second timeout |
| 6 | Validates minimum SQL Server version (2016+) |
| 7 | Checks if connected user has required permissions (VIEW SERVER STATE) |
| 8 | `POST /api/servers` can include `validate: true` to test before saving |
| 9 | If validation fails with `validate: true`, server is not created |

## Tasks / Subtasks

- [ ] Task 1: Create SQL Server connector (AC: 2, 5)
  - [ ] Create `backend/app/connectors/__init__.py`
  - [ ] Create `backend/app/connectors/sqlserver.py`
  - [ ] Implement connection string builder
  - [ ] Configure 10-second timeout

- [ ] Task 2: Implement test_connection method (AC: 3, 4, 6, 7)
  - [ ] Execute `SELECT @@VERSION` for version info
  - [ ] Check for SQL Server 2016+ (version 13+)
  - [ ] Check VIEW SERVER STATE permission
  - [ ] Return structured success/error response

- [ ] Task 3: Create test-connection endpoint (AC: 1)
  - [ ] Add POST /api/servers/test-connection
  - [ ] Accept connection parameters in body
  - [ ] Return test results

- [ ] Task 4: Add validation to create endpoint (AC: 8, 9)
  - [ ] Accept `validate: true` in POST body
  - [ ] Run connection test if validate=true
  - [ ] Return error without saving if test fails

## Dev Notes

### SQL Server Connector
```python
# backend/app/connectors/sqlserver.py
import pyodbc
from flask import current_app

class SQLServerConnector:
    def _build_connection_string(self, hostname, port, instance_name,
                                  auth_type, username=None, password=None):
        driver = current_app.config.get('SQLSERVER_DRIVER', 'ODBC Driver 18 for SQL Server')

        if instance_name:
            server = f"{hostname}\\{instance_name}"
        else:
            server = f"{hostname},{port}"

        conn_str = f"DRIVER={{{driver}}};SERVER={server};DATABASE=master;"

        if auth_type == 'windows':
            conn_str += "Trusted_Connection=yes;"
        else:
            conn_str += f"UID={username};PWD={password};"

        conn_str += "TrustServerCertificate=yes;"
        return conn_str

    def test_connection(self, **kwargs) -> dict:
        try:
            conn_str = self._build_connection_string(**kwargs)
            conn = pyodbc.connect(conn_str, timeout=10)
            cursor = conn.cursor()

            # Get version
            cursor.execute("SELECT @@VERSION")
            version = cursor.fetchone()[0]

            # Check permission
            cursor.execute("SELECT HAS_PERMS_BY_NAME(null, null, 'VIEW SERVER STATE')")
            has_permission = cursor.fetchone()[0] == 1

            conn.close()

            return {
                'success': True,
                'version': version,
                'has_permission': has_permission
            }
        except pyodbc.Error as e:
            return {
                'success': False,
                'error': str(e)
            }
```

### Required Dependencies
```
# requirements.txt
pyodbc>=5.0.0
```

### Error Response Examples
```json
// Success
{"success": true, "version": "Microsoft SQL Server 2019...", "has_permission": true}

// Failure
{"success": false, "error": "Login failed for user 'sa'"}
{"success": false, "error": "Connection timeout expired"}
```

## Testing

### Test Requirements
- Test connection string building
- Test successful connection response
- Test failure scenarios (mock pyodbc)
- Test timeout handling
- Location: `backend/tests/unit/test_sqlserver_connector.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
