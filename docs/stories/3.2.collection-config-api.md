# Story 3.2: Collection Configuration API

## Status: Ready for Review

## Story

**As a** user,
**I want** to configure data collection intervals and settings,
**so that** I can balance data granularity with resource usage.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `collection_config` table: server_id, interval_seconds, enabled, metrics_enabled (JSON array) |
| 2 | Default interval: 60 seconds |
| 3 | `GET /api/servers/{id}/collection-config` returns current config |
| 4 | `PUT /api/servers/{id}/collection-config` updates config |
| 5 | Minimum interval: 30 seconds (prevent overload) |
| 6 | Maximum interval: 3600 seconds (1 hour) |
| 7 | Can enable/disable specific metric types per server |
| 8 | `POST /api/servers/{id}/collection/start` enables collection |
| 9 | `POST /api/servers/{id}/collection/stop` disables collection |
| 10 | Config changes take effect on next collection cycle |

## Tasks / Subtasks

- [x] Task 1: Create CollectionConfig model (AC: 1, 2)
  - [x] Add model with defaults
  - [x] Create migration
  - [x] Auto-create on server creation

- [x] Task 2: Create config API (AC: 3, 4, 5, 6, 7)
  - [x] Add GET endpoint
  - [x] Add PUT endpoint with validation
  - [x] Validate interval bounds

- [x] Task 3: Add start/stop endpoints (AC: 8, 9, 10)
  - [x] Implement start collection
  - [x] Implement stop collection

## Dev Notes

### Model
```python
class CollectionConfig(db.Model):
    __tablename__ = 'collection_configs'
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'), primary_key=True)
    interval_seconds = db.Column(db.Integer, nullable=False, default=60)
    enabled = db.Column(db.Boolean, nullable=False, default=False)
    metrics_enabled = db.Column(db.JSON, default=['cpu_percent', 'memory_percent', 'connection_count'])
```

## Testing

- Test config CRUD
- Test interval validation
- Test start/stop

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created CollectionConfig model with:
  - server_id (primary key, foreign key to servers)
  - interval_seconds (default 60, min 30, max 3600)
  - enabled (boolean, default false)
  - metrics_enabled (JSON array, default ['cpu_percent', 'memory_percent', 'connection_count'])
  - last_collected_at for tracking last collection time
- Created migration 007_create_collection_configs.py
- Created CollectionConfigService with:
  - get_config(): Gets config (auto-creates if doesn't exist)
  - update_config(): Updates with validation
  - start_collection(): Enables collection
  - stop_collection(): Disables collection
  - get_enabled_servers(): Gets all servers with collection enabled
- Created API endpoints:
  - GET /api/servers/{id}/collection-config
  - PUT /api/servers/{id}/collection-config
  - POST /api/servers/{id}/collection/start
  - POST /api/servers/{id}/collection/stop
- Validation:
  - Interval must be between 30 and 3600 seconds
  - metrics_enabled must be a list of strings
- All 72 backend tests passing

### File List
- backend/app/models/tenant.py (modified - added CollectionConfig model)
- backend/migrations_tenant/versions/007_create_collection_configs.py (new)
- backend/app/services/collection_config_service.py (new)
- backend/app/api/servers.py (modified - added collection config endpoints)

---

## QA Results
