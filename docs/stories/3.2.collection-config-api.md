# Story 3.2: Collection Configuration API

## Status: Draft

## Story

**As a** user,
**I want** to configure data collection intervals and settings,
**so that** I can balance data granularity with resource usage.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `collection_config` table: server_id, interval_seconds, enabled, metrics_enabled (JSON array) |
| 2 | Default interval: 60 seconds |
| 3 | `GET /api/servers/{id}/collection-config` returns current config |
| 4 | `PUT /api/servers/{id}/collection-config` updates config |
| 5 | Minimum interval: 30 seconds (prevent overload) |
| 6 | Maximum interval: 3600 seconds (1 hour) |
| 7 | Can enable/disable specific metric types per server |
| 8 | `POST /api/servers/{id}/collection/start` enables collection |
| 9 | `POST /api/servers/{id}/collection/stop` disables collection |
| 10 | Config changes take effect on next collection cycle |

## Tasks / Subtasks

- [ ] Task 1: Create CollectionConfig model (AC: 1, 2)
  - [ ] Add model with defaults
  - [ ] Create migration
  - [ ] Auto-create on server creation

- [ ] Task 2: Create config API (AC: 3, 4, 5, 6, 7)
  - [ ] Add GET endpoint
  - [ ] Add PUT endpoint with validation
  - [ ] Validate interval bounds

- [ ] Task 3: Add start/stop endpoints (AC: 8, 9, 10)
  - [ ] Implement start collection
  - [ ] Implement stop collection

## Dev Notes

### Model
```python
class CollectionConfig(db.Model):
    __tablename__ = 'collection_configs'
    server_id = db.Column(UUID(as_uuid=True), db.ForeignKey('servers.id'), primary_key=True)
    interval_seconds = db.Column(db.Integer, nullable=False, default=60)
    enabled = db.Column(db.Boolean, nullable=False, default=False)
    metrics_enabled = db.Column(db.JSON, default=['cpu_percent', 'memory_percent', 'connection_count'])
```

## Testing

- Test config CRUD
- Test interval validation
- Test start/stop

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
