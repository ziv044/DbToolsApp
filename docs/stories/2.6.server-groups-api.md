# Story 2.6: Server Groups Data Model & API

## Status: Draft

## Story

**As a** user,
**I want** to organize servers into groups,
**so that** I can manage related servers together and apply policies to groups.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `server_groups` table: id, name, description, created_at |
| 2 | Tenant DB includes `server_group_members` junction table: server_id, group_id |
| 3 | Servers can belong to multiple groups (many-to-many) |
| 4 | `POST /api/groups` creates new group |
| 5 | `GET /api/groups` returns all groups with member count |
| 6 | `GET /api/groups/{id}` returns group with list of member servers |
| 7 | `PUT /api/groups/{id}` updates group name/description |
| 8 | `DELETE /api/groups/{id}` deletes group (servers remain, just unassigned) |
| 9 | `POST /api/groups/{id}/servers` adds servers to group (accepts array of server_ids) |
| 10 | `DELETE /api/groups/{id}/servers/{server_id}` removes server from group |
| 11 | Group name must be unique within tenant |

## Tasks / Subtasks

- [ ] Task 1: Create Group model (AC: 1, 2, 3, 11)
  - [ ] Add ServerGroup model to tenant.py
  - [ ] Add server_group_members association table
  - [ ] Add relationship to Server model
  - [ ] Create tenant migration

- [ ] Task 2: Create Group repository (AC: 4-10)
  - [ ] Create `backend/app/repositories/group_repository.py`
  - [ ] Implement CRUD operations
  - [ ] Implement member add/remove

- [ ] Task 3: Create Group service (AC: 5, 6)
  - [ ] Create `backend/app/services/group_service.py`
  - [ ] Add member count to group list
  - [ ] Add member servers to group detail

- [ ] Task 4: Create Group API endpoints (AC: 4-11)
  - [ ] Create `backend/app/api/groups.py` blueprint
  - [ ] Implement all group endpoints
  - [ ] Implement member management endpoints
  - [ ] Add @require_tenant decorator

## Dev Notes

### Models
```python
# backend/app/models/tenant.py

# Association table
server_group_members = db.Table('server_group_members',
    db.Column('server_id', UUID(as_uuid=True), db.ForeignKey('servers.id'), primary_key=True),
    db.Column('group_id', UUID(as_uuid=True), db.ForeignKey('server_groups.id'), primary_key=True),
    db.Column('added_at', db.DateTime, server_default=db.func.now())
)

class ServerGroup(db.Model):
    __tablename__ = 'server_groups'

    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False, unique=True)
    description = db.Column(db.Text, nullable=True)
    color = db.Column(db.String(7), nullable=True)  # Hex color
    created_at = db.Column(db.DateTime, server_default=db.func.now())
    updated_at = db.Column(db.DateTime, onupdate=db.func.now())

    servers = db.relationship('Server', secondary=server_group_members,
                              backref=db.backref('groups', lazy='dynamic'))
```

### API Response Examples
```json
// GET /api/groups
[
  {"id": "uuid", "name": "Production", "description": "Prod servers", "member_count": 5},
  {"id": "uuid", "name": "Development", "description": null, "member_count": 3}
]

// GET /api/groups/{id}
{
  "id": "uuid",
  "name": "Production",
  "servers": [
    {"id": "uuid", "name": "sql-prod-01", "status": "online"},
    {"id": "uuid", "name": "sql-prod-02", "status": "online"}
  ]
}
```

## Testing

### Test Requirements
- Test group CRUD operations
- Test server-group relationships
- Test member add/remove
- Test unique name constraint
- Location: `backend/tests/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
