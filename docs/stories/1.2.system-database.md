# Story 1.2: System Database & Tenant Data Model

## Status: Draft

## Story

**As a** developer,
**I want** a system database that tracks all tenants,
**so that** the platform can manage multiple isolated customers.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `dbtools_system` database created with Flask-Migrate managing schema |
| 2 | `tenants` table: id, slug (unique), name, status (active/suspended), created_at, updated_at |
| 3 | Tenant slug must be alphanumeric with hyphens, 3-50 characters |
| 4 | Database connection string configurable via environment variable |
| 5 | Initial migration creates all system tables |
| 6 | Seed script creates a default demo tenant for development |
| 7 | SQLAlchemy models defined with proper constraints |

## Tasks / Subtasks

- [ ] Task 1: Setup Flask-SQLAlchemy and Flask-Migrate (AC: 1, 4)
  - [ ] Add SQLAlchemy and Migrate to requirements.txt
  - [ ] Create `backend/app/extensions.py` with db and migrate instances
  - [ ] Update app factory to initialize extensions
  - [ ] Configure DATABASE_URL from environment

- [ ] Task 2: Create Tenant model (AC: 2, 3, 7)
  - [ ] Create `backend/app/models/__init__.py`
  - [ ] Create `backend/app/models/system.py` with Tenant model
  - [ ] Add slug validation (alphanumeric + hyphens, 3-50 chars)
  - [ ] Add proper indexes and constraints

- [ ] Task 3: Create initial migration (AC: 5)
  - [ ] Initialize migrations folder
  - [ ] Generate initial migration for tenants table
  - [ ] Test migration up/down

- [ ] Task 4: Create seed script (AC: 6)
  - [ ] Create `scripts/seed_data.py`
  - [ ] Add demo tenant creation
  - [ ] Make script idempotent (skip if exists)

## Dev Notes

### Database Configuration
```python
# backend/app/config.py
class Config:
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL',
        'postgresql://postgres:1234@localhost:5432/dbtools_system')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### Tenant Model
```python
# backend/app/models/system.py
from app.extensions import db
from sqlalchemy.dialects.postgresql import UUID
import uuid

class Tenant(db.Model):
    __tablename__ = 'tenants'

    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False)
    slug = db.Column(db.String(100), unique=True, nullable=False, index=True)
    status = db.Column(db.String(20), nullable=False, default='active')
    settings = db.Column(db.JSON, nullable=False, default=dict)
    created_at = db.Column(db.DateTime, server_default=db.func.now())
    updated_at = db.Column(db.DateTime, server_default=db.func.now(), onupdate=db.func.now())
```

### Extensions Pattern
```python
# backend/app/extensions.py
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()
```

### Slug Validation Regex
```python
import re
SLUG_PATTERN = re.compile(r'^[a-z0-9][a-z0-9-]{1,48}[a-z0-9]$')
```

## Testing

### Test Requirements
- Test Tenant model CRUD operations
- Test slug validation (valid/invalid patterns)
- Test unique constraint on slug
- Location: `backend/tests/unit/test_models.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
