# Story 1.2: System Database & Tenant Data Model

## Status: Ready for Review

## Story

**As a** developer,
**I want** a system database that tracks all tenants,
**so that** the platform can manage multiple isolated customers.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `dbtools_system` database created with Flask-Migrate managing schema |
| 2 | `tenants` table: id, slug (unique), name, status (active/suspended), created_at, updated_at |
| 3 | Tenant slug must be alphanumeric with hyphens, 3-50 characters |
| 4 | Database connection string configurable via environment variable |
| 5 | Initial migration creates all system tables |
| 6 | Seed script creates a default demo tenant for development |
| 7 | SQLAlchemy models defined with proper constraints |

## Tasks / Subtasks

- [x] Task 1: Setup Flask-SQLAlchemy and Flask-Migrate (AC: 1, 4)
  - [x] Add SQLAlchemy and Migrate to requirements.txt
  - [x] Create `backend/app/extensions.py` with db and migrate instances
  - [x] Update app factory to initialize extensions
  - [x] Configure DATABASE_URL from environment

- [x] Task 2: Create Tenant model (AC: 2, 3, 7)
  - [x] Create `backend/app/models/__init__.py`
  - [x] Create `backend/app/models/system.py` with Tenant model
  - [x] Add slug validation (alphanumeric + hyphens, 3-50 chars)
  - [x] Add proper indexes and constraints

- [x] Task 3: Create initial migration (AC: 5)
  - [x] Initialize migrations folder
  - [x] Generate initial migration for tenants table
  - [x] Test migration up/down

- [x] Task 4: Create seed script (AC: 6)
  - [x] Create `scripts/seed_data.py`
  - [x] Add demo tenant creation
  - [x] Make script idempotent (skip if exists)

## Dev Notes

### Database Configuration
```python
# backend/app/config.py
class Config:
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL',
        'postgresql://postgres:1234@localhost:5432/dbtools_system')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
```

### Tenant Model
```python
# backend/app/models/system.py
from app.extensions import db
from sqlalchemy.dialects.postgresql import UUID
import uuid

class Tenant(db.Model):
    __tablename__ = 'tenants'

    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False)
    slug = db.Column(db.String(100), unique=True, nullable=False, index=True)
    status = db.Column(db.String(20), nullable=False, default='active')
    settings = db.Column(db.JSON, nullable=False, default=dict)
    created_at = db.Column(db.DateTime, server_default=db.func.now())
    updated_at = db.Column(db.DateTime, server_default=db.func.now(), onupdate=db.func.now())
```

### Extensions Pattern
```python
# backend/app/extensions.py
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()
```

### Slug Validation Regex
```python
import re
SLUG_PATTERN = re.compile(r'^[a-z0-9][a-z0-9-]{1,48}[a-z0-9]$')
```

## Testing

### Test Requirements
- Test Tenant model CRUD operations
- Test slug validation (valid/invalid patterns)
- Test unique constraint on slug
- Location: `backend/tests/unit/test_models.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 18 backend tests pass
- Migration up/down tested successfully
- Seed script idempotency verified

### Completion Notes List
- Created extensions.py with db, migrate, cors instances
- Updated app factory to use extensions pattern
- Created Tenant model with UUID primary key, slug validation, status constraint
- Used timezone-aware datetime to fix deprecation warnings
- Created initial migration for tenants table
- Created seed_data.py with idempotent demo tenant creation
- Created create_db.py script for database creation

### File List
- backend/app/extensions.py (created)
- backend/app/models/__init__.py (created)
- backend/app/models/system.py (created)
- backend/app/__init__.py (modified)
- backend/tests/conftest.py (modified)
- backend/tests/unit/__init__.py (created)
- backend/tests/unit/test_models.py (created)
- backend/migrations/ (created - Flask-Migrate)
- scripts/create_db.py (created)
- scripts/seed_data.py (created)

---

## QA Results
(To be filled by QA agent)
