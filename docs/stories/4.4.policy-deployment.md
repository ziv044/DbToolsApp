# Story 4.4: Policy Deployment to Groups

## Status: Ready for Review

## Story

**As a** user,
**I want** to deploy policies to server groups,
**so that** all servers in a group follow the same standards.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `policy_deployments` table: id, policy_id, policy_version, group_id, deployed_at, deployed_by |
| 2 | `POST /api/policies/{id}/deploy` deploys to specified group(s) |
| 3 | Request body: { group_ids: [1, 2, 3] } |
| 4 | Creates deployment record for each group |
| 5 | `GET /api/policies/{id}/deployments` returns deployment history |
| 6 | `GET /api/groups/{id}/policies` returns policies deployed to group |
| 7 | `DELETE /api/policies/{id}/deployments/{group_id}` removes deployment |
| 8 | Policy detail page shows "Deployed To" section with group list |
| 9 | "Deploy" button opens group picker modal |
| 10 | Deployment creates associated job schedule (see scheduler stories) |

## Tasks / Subtasks

- [x] Task 1: Create PolicyDeployment model (AC: 1)
- [x] Task 2: Create deployment API (AC: 2-7)
- [x] Task 3: Add deployment UI (AC: 8, 9)
- [ ] Task 4: Create job on deployment (AC: 10) - Deferred to scheduler stories

## Dev Notes

### Deployment Model
```python
class PolicyDeployment(db.Model):
    __tablename__ = 'policy_deployments'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    policy_id = db.Column(UUID(as_uuid=True), db.ForeignKey('policies.id'), nullable=False)
    policy_version = db.Column(db.Integer, nullable=False)
    group_id = db.Column(UUID(as_uuid=True), db.ForeignKey('server_groups.id'), nullable=False)
    deployed_at = db.Column(db.DateTime, server_default=db.func.now())
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Added `PolicyDeployment` model to `backend/app/models/tenant.py`:
  - id, policy_id, policy_version, group_id, deployed_at, deployed_by fields
  - Composite unique constraint on policy_id + group_id
  - Relationships to Policy and ServerGroup
  - to_dict() method with include_policy and include_group options
- Added deployment API endpoints to `backend/app/api/policies.py`:
  - `POST /api/policies/{id}/deploy` - deploy to groups (creates/updates deployments)
  - `GET /api/policies/{id}/deployments` - list deployments for policy
  - `DELETE /api/policies/{id}/deployments/{group_id}` - remove deployment
- Added `GET /api/groups/{id}/policies` endpoint to `backend/app/api/groups.py`
- Updated `frontend/src/services/policyService.ts`:
  - Added PolicyDeployment and DeployPolicyInput types
  - Added deploy(), getDeployments(), removeDeployment() methods
- Created `frontend/src/pages/PolicyDetail.tsx`:
  - Policy header with name, type, version, status
  - Tabs: Configuration, Deployments, Version History
  - Configuration tab shows all policy settings
  - Deployments tab shows deployed groups with remove option
  - Versions tab shows version history
  - Deploy button opens deployment modal
  - Edit and Delete buttons
- Created `frontend/src/components/policies/DeployPolicyModal.tsx`:
  - Group picker with multi-select checkboxes
  - Shows existing deployments with "Deployed" badge
  - Select all / Clear selection controls
  - Deploy button with loading state
- Updated routing: added `/policies/:id` route to App.tsx
- All 72 backend tests pass
- Frontend builds successfully
- Task 4 (job schedule creation) deferred to scheduler stories

### File List
- backend/app/models/tenant.py (modified - added PolicyDeployment)
- backend/app/api/policies.py (modified - added deployment endpoints)
- backend/app/api/groups.py (modified - added policies endpoint)
- frontend/src/services/policyService.ts (modified - added deployment types and methods)
- frontend/src/pages/PolicyDetail.tsx (new)
- frontend/src/components/policies/DeployPolicyModal.tsx (new)
- frontend/src/components/policies/index.ts (modified - export DeployPolicyModal)
- frontend/src/pages/index.ts (modified - export PolicyDetail)
- frontend/src/App.tsx (modified - added PolicyDetail route)

---

## QA Results
