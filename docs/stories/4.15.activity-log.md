# Story 4.15: Activity Log

## Status: Draft

## Story

**As a** user,
**I want** an audit trail of all actions,
**so that** I can track changes and troubleshoot issues.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Activity log page at `/activity` route |
| 2 | Log entries: Timestamp, Action, Entity Type, Entity Name, Details, User (when auth added) |
| 3 | Actions logged: server_added, server_deleted, group_created, policy_deployed, job_executed, alert_triggered, config_changed |
| 4 | Filter by action type, entity type, date range |
| 5 | Search by entity name or details |
| 6 | Paginated with 50 entries per page |
| 7 | Export to CSV option |
| 8 | Activity entries created automatically by relevant APIs |
| 9 | Server detail page shows activity filtered to that server |
| 10 | Retention follows tenant settings (default 90 days) |

## Tasks / Subtasks

- [ ] Task 1: Activity log already exists (from 1.4), verify schema
- [ ] Task 2: Create activity service for logging (AC: 3, 8)
- [ ] Task 3: Create Activity page (AC: 1)
- [ ] Task 4: Create activity list (AC: 2, 6)
- [ ] Task 5: Add filters and search (AC: 4, 5)
- [ ] Task 6: Add CSV export (AC: 7)
- [ ] Task 7: Add to server detail (AC: 9)
- [ ] Task 8: Add retention cleanup (AC: 10)

## Dev Notes

### Activity Service
```python
class ActivityService:
    @staticmethod
    def log(action: str, entity_type: str, entity_id: str, details: dict = None):
        entry = ActivityLog(
            action=action,
            entity_type=entity_type,
            entity_id=entity_id,
            details=details or {}
        )
        db.session.add(entry)
        db.session.commit()

# Usage in other services
ActivityService.log('server_added', 'server', str(server.id), {'name': server.name})
```

### Activity API
```python
@bp.route('/activity')
def list_activity():
    query = ActivityLog.query

    # Filters
    if action := request.args.get('action'):
        query = query.filter_by(action=action)
    if entity_type := request.args.get('entity_type'):
        query = query.filter_by(entity_type=entity_type)
    if entity_id := request.args.get('entity_id'):
        query = query.filter_by(entity_id=entity_id)

    # Pagination
    page = request.args.get('page', 1, type=int)
    per_page = 50

    return query.order_by(ActivityLog.created_at.desc()).paginate(page, per_page)
```

### CSV Export
```typescript
const exportToCSV = (activities) => {
  const headers = ['Timestamp', 'Action', 'Entity Type', 'Entity', 'Details'];
  const rows = activities.map(a => [
    a.created_at, a.action, a.entity_type, a.entity_id, JSON.stringify(a.details)
  ]);
  // Generate and download CSV
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
### Debug Log References
### Completion Notes List
### File List

---

## QA Results
