# Story 4.15: Activity Log

## Status: Ready for Review

## Story

**As a** user,
**I want** an audit trail of all actions,
**so that** I can track changes and troubleshoot issues.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Activity log page at `/activity` route |
| 2 | Log entries: Timestamp, Action, Entity Type, Entity Name, Details, User (when auth added) |
| 3 | Actions logged: server_added, server_deleted, group_created, policy_deployed, job_executed, alert_triggered, config_changed |
| 4 | Filter by action type, entity type, date range |
| 5 | Search by entity name or details |
| 6 | Paginated with 50 entries per page |
| 7 | Export to CSV option |
| 8 | Activity entries created automatically by relevant APIs |
| 9 | Server detail page shows activity filtered to that server |
| 10 | Retention follows tenant settings (default 90 days) |

## Tasks / Subtasks

- [x] Task 1: Activity log already exists (from 1.4), verify schema
- [x] Task 2: Create activity service for logging (AC: 3, 8)
- [x] Task 3: Create Activity page (AC: 1)
- [x] Task 4: Create activity list (AC: 2, 6)
- [x] Task 5: Add filters and search (AC: 4, 5)
- [x] Task 6: Add CSV export (AC: 7)
- [x] Task 7: Add to server detail (AC: 9)
- [x] Task 8: Add retention cleanup (AC: 10)

## Dev Notes

### Activity Service
```python
class ActivityService:
    @staticmethod
    def log(action: str, entity_type: str, entity_id: str, details: dict = None):
        entry = ActivityLog(
            action=action,
            entity_type=entity_type,
            entity_id=entity_id,
            details=details or {}
        )
        db.session.add(entry)
        db.session.commit()

# Usage in other services
ActivityService.log('server_added', 'server', str(server.id), {'name': server.name})
```

### Activity API
```python
@bp.route('/activity')
def list_activity():
    query = ActivityLog.query

    # Filters
    if action := request.args.get('action'):
        query = query.filter_by(action=action)
    if entity_type := request.args.get('entity_type'):
        query = query.filter_by(entity_type=entity_type)
    if entity_id := request.args.get('entity_id'):
        query = query.filter_by(entity_id=entity_id)

    # Pagination
    page = request.args.get('page', 1, type=int)
    per_page = 50

    return query.order_by(ActivityLog.created_at.desc()).paginate(page, per_page)
```

### CSV Export
```typescript
const exportToCSV = (activities) => {
  const headers = ['Timestamp', 'Action', 'Entity Type', 'Entity', 'Details'];
  const rows = activities.map(a => [
    a.created_at, a.action, a.entity_type, a.entity_id, JSON.stringify(a.details)
  ]);
  // Generate and download CSV
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Verified `ActivityLog` model already exists in `backend/app/models/tenant.py`:
  - Action types: alert_triggered, alert_resolved, alert_acknowledged, job_executed, job_failed, policy_deployed, server_online, server_offline
  - Entity types: alert, job, policy, server
  - Fields: id, action, entity_type, entity_id, details (JSONB), created_at
- Created `backend/app/services/activity_service.py`:
  - `ActivityService` class with methods:
    - `log()` - log single activity entry
    - `log_batch()` - log multiple entries at once
    - `get_activities()` - retrieve with filters, search, pagination
    - `get_activity()` - get single entry by ID
    - `get_entity_activities()` - get activities for specific entity
    - `cleanup_old_entries()` - retention cleanup (default 90 days)
    - `get_action_types()` / `get_entity_types()` - filter options
  - `log_activity()` convenience function
- Created `backend/app/api/activity.py`:
  - `GET /activity` - list with filters, search, pagination (50 per page default)
  - `GET /activity/<id>` - single entry
  - `GET /activity/filters` - available filter options
  - `GET /activity/export` - CSV export
  - `GET /activity/entity/<type>/<id>` - entity-specific activities
- Created `frontend/src/services/activityService.ts`:
  - Types: ActivityLog, ActivitiesResponse, ActivityFilters, EntityActivitiesResponse
  - Constants: ACTION_LABELS, ENTITY_TYPE_LABELS
  - Service methods for all activity API endpoints
  - `getExportUrl()` for CSV export link generation
- Created `frontend/src/pages/Activity.tsx`:
  - Activity log page at `/activity` route
  - Filters: Action type, Entity type, Date range
  - Search by entity name or details
  - Pagination (50 entries per page)
  - CSV export button
  - Entity links to related pages (servers, alerts, jobs)
  - 30-second auto-refresh with tab visibility handling
- Updated `frontend/src/pages/ServerDetail.tsx`:
  - Added real activity data to "Recent Activity" card
  - Shows last 5 activities for the server
  - Color-coded icons by action type
  - "View All" link to filtered activity page
- Updated `frontend/src/components/layout/Sidebar.tsx` - added Activity nav item
- Updated `frontend/src/pages/index.ts` - exported Activity page
- Updated `frontend/src/App.tsx` - added `/activity` route
- All 72 backend tests pass
- Frontend builds successfully

### File List
- backend/app/services/activity_service.py (new)
- backend/app/api/activity.py (new)
- backend/app/api/__init__.py (modified - registered activity blueprint)
- frontend/src/services/activityService.ts (new)
- frontend/src/pages/Activity.tsx (new)
- frontend/src/pages/ServerDetail.tsx (modified - added real activity data)
- frontend/src/components/layout/Sidebar.tsx (modified - added Activity nav)
- frontend/src/pages/index.ts (modified - exported Activity)
- frontend/src/App.tsx (modified - added /activity route)

---

## QA Results
