# Story 1.5: Tenant Selection & Context Middleware

## Status: Ready for Review

## Story

**As a** user,
**I want** to select which tenant I'm working with,
**so that** all my actions are scoped to that tenant's data.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | API accepts `X-Tenant-Slug` header to identify tenant context |
| 2 | Middleware validates tenant exists and is active |
| 3 | Middleware establishes connection to correct tenant database |
| 4 | Database connection available via Flask `g` object in routes |
| 5 | Returns 400 if header missing on tenant-scoped endpoints |
| 6 | Returns 404 if tenant not found |
| 7 | Returns 403 if tenant is suspended |
| 8 | System-level endpoints (`/api/tenants`) don't require tenant header |
| 9 | Tenant context logged for all requests |

## Tasks / Subtasks

- [x] Task 1: Create tenant middleware (AC: 1, 2, 3, 4)
  - [x] Create `backend/app/middleware/__init__.py`
  - [x] Create `backend/app/middleware/tenant.py`
  - [x] Implement TenantMiddleware class
  - [x] Extract tenant from X-Tenant-Slug header
  - [x] Validate tenant exists and is active
  - [x] Establish tenant DB session on Flask g

- [x] Task 2: Implement error responses (AC: 5, 6, 7)
  - [x] Return 400 for missing header
  - [x] Return 404 for unknown tenant
  - [x] Return 403 for suspended tenant

- [x] Task 3: Add system endpoint exclusions (AC: 8)
  - [x] Skip middleware for /api/tenants routes
  - [x] Skip middleware for /api/health route

- [x] Task 4: Add request logging (AC: 9)
  - [x] Log tenant slug on each request
  - [x] Include request ID for tracing

- [x] Task 5: Create require_tenant decorator (AC: 4)
  - [x] Decorator checks g.tenant exists
  - [x] Returns error if no tenant context

## Dev Notes

### Middleware Implementation
```python
# backend/app/middleware/tenant.py
from flask import request, g
from app.extensions import db
from app.models.system import Tenant
from app.core.tenant_manager import tenant_manager

class TenantMiddleware:
    EXCLUDED_PATHS = ['/api/health', '/api/tenants']

    def __init__(self, app=None):
        if app:
            self.init_app(app)

    def init_app(self, app):
        app.before_request(self.resolve_tenant)
        app.teardown_request(self.cleanup_tenant)

    def resolve_tenant(self):
        # Skip for excluded paths
        if any(request.path.startswith(p) for p in self.EXCLUDED_PATHS):
            return None

        slug = request.headers.get('X-Tenant-Slug')
        if not slug:
            return {'error': {'code': 'MISSING_TENANT', 'message': 'X-Tenant-Slug header required'}}, 400

        tenant = db.session.query(Tenant).filter_by(slug=slug).first()
        if not tenant:
            return {'error': {'code': 'TENANT_NOT_FOUND', 'message': f'Tenant {slug} not found'}}, 404

        if tenant.status == 'suspended':
            return {'error': {'code': 'TENANT_SUSPENDED', 'message': 'Tenant is suspended'}}, 403

        g.tenant = tenant
        g.tenant_session = tenant_manager.get_session(slug)

    def cleanup_tenant(self, exception=None):
        session = getattr(g, 'tenant_session', None)
        if session:
            session.remove()
```

### require_tenant Decorator
```python
from functools import wraps
from flask import g

def require_tenant(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        if not hasattr(g, 'tenant'):
            return {'error': {'code': 'NO_TENANT', 'message': 'Tenant context required'}}, 400
        return f(*args, **kwargs)
    return decorated
```

## Testing

### Test Requirements
- Test middleware sets g.tenant for valid requests
- Test 400 response when header missing
- Test 404 response for unknown tenant
- Test 403 response for suspended tenant
- Test excluded paths skip middleware
- Location: `backend/tests/unit/test_middleware.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 37 tests pass (27 unit + 10 integration)
- Middleware tests: 9 tests (4 exclusion + 5 integration)

### Completion Notes List
- Created TenantMiddleware with before_request/teardown_request hooks
- Middleware sets g.tenant and g.tenant_session for valid requests
- Excluded paths: /api/health, /api/tenants (and subpaths)
- Error responses: 400 missing header, 404 not found, 403 suspended
- Added request ID (g.request_id) for tracing
- Created require_tenant decorator for explicit checks
- Updated conftest.py with test endpoint for middleware testing

### File List
- backend/app/middleware/__init__.py (created)
- backend/app/middleware/tenant.py (created)
- backend/app/__init__.py (modified - add middleware init)
- backend/tests/conftest.py (modified - add test endpoint)
- backend/tests/unit/test_middleware.py (created)

---

## QA Results
(To be filled by QA agent)
