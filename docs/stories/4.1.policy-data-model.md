# Story 4.1: Policy Data Model & API

## Status: Ready for Review

## Story

**As a** user,
**I want** to create and manage reusable policies,
**so that** I can standardize operations across my SQL Server fleet.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `policies` table: id, name, type, description, configuration (JSON), version, is_active, created_at, updated_at |
| 2 | Policy types: backup, index_maintenance, integrity_check, custom_script |
| 3 | `POST /api/policies` creates new policy |
| 4 | `GET /api/policies` returns all policies with version info |
| 5 | `GET /api/policies/{id}` returns policy with full configuration |
| 6 | `PUT /api/policies/{id}` creates new version (immutable versioning) |
| 7 | `DELETE /api/policies/{id}` soft-deletes policy |
| 8 | Policy name must be unique within tenant |
| 9 | Configuration schema varies by type (validated on save) |
| 10 | `GET /api/policies/{id}/versions` returns version history |

## Tasks / Subtasks

- [x] Task 1: Create Policy model (AC: 1, 2, 8)
- [x] Task 2: Create policy repository and service
- [x] Task 3: Implement versioning logic (AC: 6, 10)
- [x] Task 4: Create API endpoints (AC: 3-7)
- [x] Task 5: Add configuration validation (AC: 9)

## Dev Notes

### Policy Model
```python
class Policy(db.Model):
    __tablename__ = 'policies'
    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False, unique=True)
    type = db.Column(db.String(50), nullable=False)  # backup, maintenance, etc.
    description = db.Column(db.Text)
    configuration = db.Column(db.JSON, nullable=False, default=dict)
    version = db.Column(db.Integer, nullable=False, default=1)
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, server_default=db.func.now())
    updated_at = db.Column(db.DateTime, onupdate=db.func.now())
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No issues encountered during development

### Completion Notes List
- Created Policy and PolicyVersion models in `backend/app/models/tenant.py`:
  - Policy: id, name, type, description, configuration (JSON), version, is_active, is_deleted, created_at, updated_at
  - PolicyVersion: id, policy_id, version, configuration (JSON), description, created_at
  - Policy types: backup, index_maintenance, integrity_check, custom_script
  - Unique constraint on policy name within tenant
  - Relationship between Policy and PolicyVersion for version history
- Created `backend/app/services/policy_service.py`:
  - POLICY_SCHEMAS defining validation rules for each policy type
  - PolicyValidationError exception class
  - PolicyService with: create_policy, get_policy, get_all_policies, update_policy, delete_policy, get_policy_versions, get_policy_version
  - Configuration validation with required fields, valid values, and defaults
  - Immutable versioning: updates to configuration create new version
- Created `backend/app/api/policies.py`:
  - GET /api/policies - list all policies with optional type/active filters
  - POST /api/policies - create new policy
  - GET /api/policies/{id} - get policy by ID
  - PUT /api/policies/{id} - update policy (creates new version on config change)
  - DELETE /api/policies/{id} - soft-delete policy
  - GET /api/policies/{id}/versions - get version history
  - GET /api/policies/{id}/versions/{version} - get specific version
  - GET /api/policies/schemas - get all policy type schemas
  - GET /api/policies/schemas/{type} - get specific schema
- Registered policies module in `backend/app/api/__init__.py`
- All 72 backend tests passing

### File List
- backend/app/models/tenant.py (modified - added Policy, PolicyVersion models)
- backend/app/services/policy_service.py (new)
- backend/app/api/policies.py (new)
- backend/app/api/__init__.py (modified - added policies import)

---

## QA Results
