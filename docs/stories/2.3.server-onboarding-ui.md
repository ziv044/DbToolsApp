# Story 2.3: Server Onboarding UI

## Status: Ready for Review

## Story

**As a** user,
**I want** a form to add new SQL Server instances,
**so that** I can onboard servers into DbTools.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | "Add Server" button opens onboarding modal/wizard |
| 2 | Form fields: Display Name, Host, Port (default 1433), Instance Name (optional) |
| 3 | Auth type selector: SQL Authentication, Windows Authentication |
| 4 | Username and Password fields (password masked) |
| 5 | "Test Connection" button validates before saving |
| 6 | Shows connection result: success (version info) or error message |
| 7 | "Save" button disabled until connection test passes |
| 8 | Form validation with inline error messages |
| 9 | Success toast and redirect to server list on save |
| 10 | Cancel button closes modal without saving |

## Tasks / Subtasks

- [x] Task 1: Create server form component (AC: 2, 3, 4)
  - [x] Create `src/components/servers/ServerForm.tsx`
  - [x] Add form fields with custom Input, Select
  - [x] Toggle username/password based on auth type
  - [x] Add password masking

- [x] Task 2: Add form validation (AC: 8)
  - [x] Install react-hook-form and zod
  - [x] Create validation schema
  - [x] Display inline error messages
  - [x] Validate required fields

- [x] Task 3: Implement connection test (AC: 5, 6, 7)
  - [x] Add "Test Connection" button
  - [x] Call POST /api/servers/test-connection
  - [x] Display success with version info
  - [x] Display error message on failure
  - [x] Track connection test state

- [x] Task 4: Implement save flow (AC: 9)
  - [x] Create server service with create method
  - [x] Call POST /api/servers with validate=true
  - [x] Show success toast
  - [x] Navigate to /servers

- [x] Task 5: Create modal wrapper (AC: 1, 10)
  - [x] Create `src/components/servers/AddServerModal.tsx`
  - [x] Use custom Modal component
  - [x] Handle open/close state
  - [x] Add Cancel button

## Dev Notes

### Form Schema
```typescript
import { z } from 'zod';

const serverSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  hostname: z.string().min(1, 'Host is required'),
  port: z.number().min(1).max(65535).default(1433),
  instanceName: z.string().optional(),
  authType: z.enum(['sql', 'windows']),
  username: z.string().optional(),
  password: z.string().optional(),
}).refine(data => {
  if (data.authType === 'sql') {
    return data.username && data.password;
  }
  return true;
}, { message: 'Username and password required for SQL auth' });
```

### Server Service
```typescript
// src/services/serverService.ts
export const serverService = {
  testConnection: async (params: TestConnectionParams) => {
    const { data } = await apiClient.post('/servers/test-connection', params);
    return data;
  },

  create: async (input: CreateServerInput) => {
    const { data } = await apiClient.post('/servers', { ...input, validate: true });
    return data;
  },
};
```

### Component Structure
```
src/components/servers/
├── AddServerModal.tsx    # Modal wrapper
├── ServerForm.tsx        # Form component
└── ConnectionTestResult.tsx  # Success/error display
```

## Testing

### Test Requirements
- Test form validation
- Test auth type toggle shows/hides fields
- Test connection test button flow
- Test save with validation
- Location: `frontend/tests/components/servers/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript build errors fixed: toast API usage, Badge variant prop, Zod schema type inference
- Used custom UI components instead of shadcn (per project convention)

### Completion Notes List
- ServerForm.tsx with Zod validation schema and react-hook-form
- Form includes: Display Name, Host, Port, Instance Name, Auth Type, Username, Password
- Auth type toggle shows/hides username/password fields for SQL auth
- Windows auth shows informational message
- Test Connection button validates before enabling Save
- Connection result shows Edition, Version, and warnings for:
  - Unsupported SQL Server versions (pre-2016)
  - Missing VIEW SERVER STATE permission
- Save button disabled until connection test passes
- Success toast and query invalidation on save
- AddServerModal wraps form with Modal component
- Servers page updated with Add Server button, empty state, and server list table
- Installed react-hook-form, zod, @hookform/resolvers packages

### File List
- frontend/src/services/serverService.ts (new)
- frontend/src/components/servers/ServerForm.tsx (new)
- frontend/src/components/servers/AddServerModal.tsx (new)
- frontend/src/components/servers/index.ts (new)
- frontend/src/pages/Servers.tsx (modified)
- frontend/src/components/ui/Modal.tsx (modified - added xl size)
- frontend/package.json (modified - added form dependencies)

---

## QA Results
(To be filled by QA agent)
