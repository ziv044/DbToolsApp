# Story 2.3: Server Onboarding UI

## Status: Draft

## Story

**As a** user,
**I want** a form to add new SQL Server instances,
**so that** I can onboard servers into DbTools.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | "Add Server" button opens onboarding modal/wizard |
| 2 | Form fields: Display Name, Host, Port (default 1433), Instance Name (optional) |
| 3 | Auth type selector: SQL Authentication, Windows Authentication |
| 4 | Username and Password fields (password masked) |
| 5 | "Test Connection" button validates before saving |
| 6 | Shows connection result: success (version info) or error message |
| 7 | "Save" button disabled until connection test passes |
| 8 | Form validation with inline error messages |
| 9 | Success toast and redirect to server list on save |
| 10 | Cancel button closes modal without saving |

## Tasks / Subtasks

- [ ] Task 1: Create server form component (AC: 2, 3, 4)
  - [ ] Create `src/components/servers/ServerForm.tsx`
  - [ ] Add form fields with shadcn Input, Select
  - [ ] Toggle username/password based on auth type
  - [ ] Add password masking

- [ ] Task 2: Add form validation (AC: 8)
  - [ ] Install react-hook-form and zod
  - [ ] Create validation schema
  - [ ] Display inline error messages
  - [ ] Validate required fields

- [ ] Task 3: Implement connection test (AC: 5, 6, 7)
  - [ ] Add "Test Connection" button
  - [ ] Call POST /api/servers/test-connection
  - [ ] Display success with version info
  - [ ] Display error message on failure
  - [ ] Track connection test state

- [ ] Task 4: Implement save flow (AC: 9)
  - [ ] Create server service with create method
  - [ ] Call POST /api/servers with validate=true
  - [ ] Show success toast
  - [ ] Navigate to /servers

- [ ] Task 5: Create modal wrapper (AC: 1, 10)
  - [ ] Create `src/components/servers/AddServerModal.tsx`
  - [ ] Use shadcn Dialog
  - [ ] Handle open/close state
  - [ ] Add Cancel button

## Dev Notes

### Form Schema
```typescript
import { z } from 'zod';

const serverSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  hostname: z.string().min(1, 'Host is required'),
  port: z.number().min(1).max(65535).default(1433),
  instanceName: z.string().optional(),
  authType: z.enum(['sql', 'windows']),
  username: z.string().optional(),
  password: z.string().optional(),
}).refine(data => {
  if (data.authType === 'sql') {
    return data.username && data.password;
  }
  return true;
}, { message: 'Username and password required for SQL auth' });
```

### Server Service
```typescript
// src/services/serverService.ts
export const serverService = {
  testConnection: async (params: TestConnectionParams) => {
    const { data } = await apiClient.post('/servers/test-connection', params);
    return data;
  },

  create: async (input: CreateServerInput) => {
    const { data } = await apiClient.post('/servers', { ...input, validate: true });
    return data;
  },
};
```

### Component Structure
```
src/components/servers/
├── AddServerModal.tsx    # Modal wrapper
├── ServerForm.tsx        # Form component
└── ConnectionTestResult.tsx  # Success/error display
```

## Testing

### Test Requirements
- Test form validation
- Test auth type toggle shows/hides fields
- Test connection test button flow
- Test save with validation
- Location: `frontend/tests/components/servers/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
