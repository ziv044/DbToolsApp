# Story 1.3: Tenant Provisioning API

## Status: Ready for Review

## Story

**As an** operator,
**I want** to create new tenants via API,
**so that** each customer gets their own isolated database automatically.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `POST /api/tenants` creates tenant record in system database |
| 2 | API automatically creates new PostgreSQL database `dbtools_tenant_{slug}` |
| 3 | API runs all tenant migrations on newly created database |
| 4 | Tenant database includes base tables: settings, activity_log |
| 5 | Returns 201 with tenant details on success |
| 6 | Returns 409 if slug already exists |
| 7 | Returns 400 with validation errors for invalid input |
| 8 | `GET /api/tenants` lists all tenants with status |
| 9 | `DELETE /api/tenants/{slug}` marks tenant as deleted (soft delete) |
| 10 | Provisioning is transactional - rollback DB creation on failure |

## Tasks / Subtasks

- [x] Task 1: Create TenantManager for multi-DB operations (AC: 2, 3, 10)
  - [x] Create `backend/app/core/__init__.py`
  - [x] Create `backend/app/core/tenant_manager.py`
  - [x] Implement `provision_database(slug)` method
  - [x] Implement `run_migrations(slug)` method
  - [x] Add rollback on failure

- [x] Task 2: Create tenant API blueprint (AC: 1, 5, 6, 7, 8, 9)
  - [x] Create `backend/app/api/__init__.py`
  - [x] Create `backend/app/api/tenants.py` blueprint
  - [x] Implement POST /api/tenants endpoint
  - [x] Implement GET /api/tenants endpoint
  - [x] Implement DELETE /api/tenants/{slug} endpoint
  - [x] Add input validation with error responses

- [x] Task 3: Create tenant database schema template (AC: 4)
  - [x] Create tenant migrations folder structure
  - [x] Create settings table migration
  - [x] Create activity_log table migration

- [x] Task 4: Register blueprint and test (AC: 1-10)
  - [x] Register tenants blueprint in app factory
  - [x] Test full provisioning flow
  - [x] Test error cases (duplicate slug, invalid input)

## Dev Notes

### TenantManager Implementation
```python
# backend/app/core/tenant_manager.py
from sqlalchemy import create_engine, text
from flask import current_app

class TenantManager:
    def get_tenant_db_url(self, slug: str) -> str:
        host = current_app.config['TENANT_DB_HOST']
        port = current_app.config['TENANT_DB_PORT']
        user = current_app.config['TENANT_DB_USER']
        password = current_app.config['TENANT_DB_PASSWORD']
        return f"postgresql://{user}:{password}@{host}:{port}/dbtools_tenant_{slug}"

    def provision_database(self, slug: str) -> None:
        system_url = current_app.config['DATABASE_URL']
        system_engine = create_engine(system_url)

        with system_engine.connect() as conn:
            conn.execution_options(isolation_level="AUTOCOMMIT")
            conn.execute(text(f"CREATE DATABASE dbtools_tenant_{slug}"))

        self._run_migrations(slug)

tenant_manager = TenantManager()
```

### API Response Formats
```python
# Success (201)
{"id": "uuid", "name": "Acme Corp", "slug": "acme", "status": "active", "created_at": "..."}

# Error (400)
{"error": {"code": "VALIDATION_ERROR", "message": "Invalid slug format", "details": [...]}}

# Error (409)
{"error": {"code": "CONFLICT", "message": "Tenant with slug 'acme' already exists"}}
```

### Tenant Database Tables
```sql
-- settings table
CREATE TABLE settings (
    key VARCHAR(100) PRIMARY KEY,
    value JSONB NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- activity_log table
CREATE TABLE activity_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    action VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50),
    entity_id UUID,
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## Testing

### Test Requirements
- Test POST creates tenant and database
- Test GET returns tenant list
- Test DELETE soft-deletes tenant
- Test 409 on duplicate slug
- Test 400 on invalid input
- Location: `backend/tests/integration/test_tenants_api.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 28 tests pass (18 unit + 10 integration)
- Integration tests verify full provisioning flow
- Tested: create, list, get, delete tenant endpoints
- Tested: duplicate slug (409), invalid input (400), not found (404)

### Completion Notes List
- Created TenantManager with database provisioning and cleanup
- Implemented multi-database support with engine/session caching
- Created tenant API blueprint with full CRUD endpoints
- Tenant databases include settings and activity_log tables
- Standardized error responses with code, message, details
- Added rollback logic for failed provisioning

### File List
- backend/app/config.py (modified - added tenant DB settings)
- backend/app/__init__.py (modified - register blueprint)
- backend/app/core/__init__.py (created)
- backend/app/core/tenant_manager.py (created)
- backend/app/api/__init__.py (created)
- backend/app/api/tenants.py (created)
- backend/tests/integration/__init__.py (created)
- backend/tests/integration/test_tenants_api.py (created)

---

## QA Results
(To be filled by QA agent)
