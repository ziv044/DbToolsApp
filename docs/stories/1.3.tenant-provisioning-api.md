# Story 1.3: Tenant Provisioning API

## Status: Draft

## Story

**As an** operator,
**I want** to create new tenants via API,
**so that** each customer gets their own isolated database automatically.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | `POST /api/tenants` creates tenant record in system database |
| 2 | API automatically creates new PostgreSQL database `dbtools_tenant_{slug}` |
| 3 | API runs all tenant migrations on newly created database |
| 4 | Tenant database includes base tables: settings, activity_log |
| 5 | Returns 201 with tenant details on success |
| 6 | Returns 409 if slug already exists |
| 7 | Returns 400 with validation errors for invalid input |
| 8 | `GET /api/tenants` lists all tenants with status |
| 9 | `DELETE /api/tenants/{slug}` marks tenant as deleted (soft delete) |
| 10 | Provisioning is transactional - rollback DB creation on failure |

## Tasks / Subtasks

- [ ] Task 1: Create TenantManager for multi-DB operations (AC: 2, 3, 10)
  - [ ] Create `backend/app/core/__init__.py`
  - [ ] Create `backend/app/core/tenant_manager.py`
  - [ ] Implement `provision_database(slug)` method
  - [ ] Implement `run_migrations(slug)` method
  - [ ] Add rollback on failure

- [ ] Task 2: Create tenant API blueprint (AC: 1, 5, 6, 7, 8, 9)
  - [ ] Create `backend/app/api/__init__.py`
  - [ ] Create `backend/app/api/tenants.py` blueprint
  - [ ] Implement POST /api/tenants endpoint
  - [ ] Implement GET /api/tenants endpoint
  - [ ] Implement DELETE /api/tenants/{slug} endpoint
  - [ ] Add input validation with error responses

- [ ] Task 3: Create tenant database schema template (AC: 4)
  - [ ] Create tenant migrations folder structure
  - [ ] Create settings table migration
  - [ ] Create activity_log table migration

- [ ] Task 4: Register blueprint and test (AC: 1-10)
  - [ ] Register tenants blueprint in app factory
  - [ ] Test full provisioning flow
  - [ ] Test error cases (duplicate slug, invalid input)

## Dev Notes

### TenantManager Implementation
```python
# backend/app/core/tenant_manager.py
from sqlalchemy import create_engine, text
from flask import current_app

class TenantManager:
    def get_tenant_db_url(self, slug: str) -> str:
        host = current_app.config['TENANT_DB_HOST']
        port = current_app.config['TENANT_DB_PORT']
        user = current_app.config['TENANT_DB_USER']
        password = current_app.config['TENANT_DB_PASSWORD']
        return f"postgresql://{user}:{password}@{host}:{port}/dbtools_tenant_{slug}"

    def provision_database(self, slug: str) -> None:
        system_url = current_app.config['DATABASE_URL']
        system_engine = create_engine(system_url)

        with system_engine.connect() as conn:
            conn.execution_options(isolation_level="AUTOCOMMIT")
            conn.execute(text(f"CREATE DATABASE dbtools_tenant_{slug}"))

        self._run_migrations(slug)

tenant_manager = TenantManager()
```

### API Response Formats
```python
# Success (201)
{"id": "uuid", "name": "Acme Corp", "slug": "acme", "status": "active", "created_at": "..."}

# Error (400)
{"error": {"code": "VALIDATION_ERROR", "message": "Invalid slug format", "details": [...]}}

# Error (409)
{"error": {"code": "CONFLICT", "message": "Tenant with slug 'acme' already exists"}}
```

### Tenant Database Tables
```sql
-- settings table
CREATE TABLE settings (
    key VARCHAR(100) PRIMARY KEY,
    value JSONB NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- activity_log table
CREATE TABLE activity_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    action VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50),
    entity_id UUID,
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## Testing

### Test Requirements
- Test POST creates tenant and database
- Test GET returns tenant list
- Test DELETE soft-deletes tenant
- Test 409 on duplicate slug
- Test 400 on invalid input
- Location: `backend/tests/integration/test_tenants_api.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### File List
(To be filled by dev agent)

---

## QA Results
(To be filled by QA agent)
