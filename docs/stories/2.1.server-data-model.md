# Story 2.1: Server Data Model & API

## Status: Ready for Review

## Story

**As a** user,
**I want** to store SQL Server connection information,
**so that** DbTools can connect to and monitor my instances.

## Acceptance Criteria

| # | Criteria |
|---|----------|
| 1 | Tenant DB includes `servers` table: id, name, host, port (default 1433), instance_name (nullable), auth_type (sql/windows), username, password_encrypted, status, created_at, updated_at |
| 2 | Password stored encrypted using Fernet symmetric encryption (key from env) |
| 3 | `POST /api/servers` creates new server entry |
| 4 | `GET /api/servers` returns list of all servers for tenant |
| 5 | `GET /api/servers/{id}` returns server details (password excluded) |
| 6 | `PUT /api/servers/{id}` updates server details |
| 7 | `DELETE /api/servers/{id}` soft-deletes server |
| 8 | API validates required fields: name, host, auth_type |
| 9 | Server name must be unique within tenant |
| 10 | Supports named instances (host\instance format or separate field) |

## Tasks / Subtasks

- [x] Task 1: Create encryption utilities (AC: 2)
  - [x] Create `backend/app/core/encryption.py`
  - [x] Implement `encrypt_password(password)` function
  - [x] Implement `decrypt_password(encrypted)` function
  - [x] Use Fernet with key from ENCRYPTION_KEY env var

- [x] Task 2: Create Server model (AC: 1, 9, 10)
  - [x] Create `backend/app/models/tenant.py`
  - [x] Define Server model with all fields
  - [x] Add unique constraint on (tenant context, name)
  - [x] Add tenant migration for servers table

- [x] Task 3: Create Server repository (AC: 3-7)
  - [x] Create `backend/app/repositories/__init__.py`
  - [x] Create `backend/app/repositories/base.py`
  - [x] Create `backend/app/repositories/server_repository.py`
  - [x] Implement CRUD operations

- [x] Task 4: Create Server service (AC: 2, 8)
  - [x] Create `backend/app/services/__init__.py`
  - [x] Create `backend/app/services/server_service.py`
  - [x] Handle password encryption on create/update
  - [x] Add validation logic

- [x] Task 5: Create Server API endpoints (AC: 3-8)
  - [x] Create `backend/app/api/servers.py` blueprint
  - [x] Implement POST /api/servers
  - [x] Implement GET /api/servers
  - [x] Implement GET /api/servers/{id}
  - [x] Implement PUT /api/servers/{id}
  - [x] Implement DELETE /api/servers/{id}
  - [x] Add @require_tenant decorator

## Dev Notes

### Encryption Implementation
```python
# backend/app/core/encryption.py
from cryptography.fernet import Fernet
from flask import current_app

def get_fernet():
    key = current_app.config['ENCRYPTION_KEY']
    return Fernet(key.encode())

def encrypt_password(password: str) -> str:
    f = get_fernet()
    return f.encrypt(password.encode()).decode()

def decrypt_password(encrypted: str) -> str:
    f = get_fernet()
    return f.decrypt(encrypted.encode()).decode()
```

### Server Model
```python
# backend/app/models/tenant.py
class Server(db.Model):
    __tablename__ = 'servers'

    id = db.Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = db.Column(db.String(255), nullable=False)
    hostname = db.Column(db.String(255), nullable=False)
    port = db.Column(db.Integer, nullable=False, default=1433)
    instance_name = db.Column(db.String(100), nullable=True)
    auth_type = db.Column(db.String(20), nullable=False)  # 'sql' or 'windows'
    username = db.Column(db.String(100), nullable=True)
    encrypted_password = db.Column(db.Text, nullable=True)
    status = db.Column(db.String(20), nullable=False, default='unknown')
    last_checked = db.Column(db.DateTime, nullable=True)
    created_at = db.Column(db.DateTime, server_default=db.func.now())
    updated_at = db.Column(db.DateTime, onupdate=db.func.now())

    def to_dict(self):
        return {
            'id': str(self.id),
            'name': self.name,
            'hostname': self.hostname,
            'port': self.port,
            'instance_name': self.instance_name,
            'auth_type': self.auth_type,
            'username': self.username,
            'status': self.status,
            'last_checked': self.last_checked.isoformat() if self.last_checked else None,
            'created_at': self.created_at.isoformat(),
        }
```

### Environment Variable
```
ENCRYPTION_KEY=your-32-byte-base64-encoded-key
# Generate with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

## Testing

### Test Requirements
- Test Server model CRUD
- Test password encryption/decryption
- Test API endpoints return correct responses
- Test password not returned in API response
- Location: `backend/tests/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-17 | 0.1 | Initial story creation | PM (John) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed SQLAlchemy 2.0 deprecation warning for declarative_base import
- Updated TestingConfig with valid Fernet encryption key for tests
- Server model uses TenantBase (separate from system db models)

### Completion Notes List
- Created encryption utilities with Fernet symmetric encryption
- ENCRYPTION_KEY added to config (from env var or default)
- Server model with all required fields in tenant database
- Tenant migration 003_create_servers.py for servers table
- Unique index on server name (excluding soft-deleted)
- Repository layer with base class and server-specific operations
- Service layer with validation and password encryption
- Full CRUD API endpoints with @require_tenant decorator
- Password never exposed in API responses
- Supports named instances via instance_name field
- 53 tests passing (added 16 new tests for encryption and server model)

### File List
- backend/app/config.py (modified - added ENCRYPTION_KEY)
- backend/app/core/encryption.py (new)
- backend/app/models/tenant.py (new)
- backend/app/repositories/__init__.py (new)
- backend/app/repositories/base.py (new)
- backend/app/repositories/server_repository.py (new)
- backend/app/services/__init__.py (new)
- backend/app/services/server_service.py (new)
- backend/app/api/__init__.py (modified)
- backend/app/api/servers.py (new)
- backend/migrations_tenant/versions/003_create_servers.py (new)
- backend/tests/unit/test_encryption.py (new)
- backend/tests/unit/test_server_model.py (new)
- .env.example (modified - added ENCRYPTION_KEY)

---

## QA Results
(To be filled by QA agent)
